<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTS Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://slelvrwtokiqlhletpsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZWx2cnd0b2tpcWxobGV0cHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODM3MTEsImV4cCI6MjA3NzM1OTcxMX0.mvO2vGyMlvmeV0tn60RL9dbzKkScBfXcFqMY-rTBmHM';
        const ADMIN_PASSWORD = 'UTS2025Admin';
        
        let supabase = null;
        let useLocalStorage = true;

        if (SUPABASE_URL && SUPABASE_KEY) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                useLocalStorage = false;
                console.log('Supabase connected successfully');
            } catch (e) {
                console.log('Supabase connection failed, using local storage:', e);
                useLocalStorage = true;
            }
        }

        const app = {
            items: [],
            usageHistory: [],
            projectFoods: [],
            selectedCategory: 'All',
            currentView: 'inventory',
            isAdmin: false,
            backupCount: 10,
            editingItemId: null,
            categories: ['All', 'Pasta/Grain', 'Canned Goods', 'Disposables', 'Equipment', 'Baking', 'Condiments', 'Stocks/Gravies', 'Seasoning', 'Bread', 'Frozen Meat', 'Prepared Meals', 'Frozen Veg', 'Fresh Fruit', 'Fresh Veg', 'Dairy', 'Baked Goods', 'Giveaways', 'Toiletries', 'Showers', 'Misc'],

            async init() {
                this.loadCategories();
                await this.loadData();
                this.loadUsageHistory();
                this.loadProjectFoods();
                this.render();
                
                if (!useLocalStorage && supabase) {
                    try {
                        supabase.channel('inventory_changes').on('postgres_changes', 
                            { event: '*', schema: 'public', table: 'inventory' }, 
                            () => this.loadData()
                        ).subscribe();
                    } catch (e) {
                        console.log('Real-time subscription failed:', e);
                    }
                }
                
                setInterval(() => this.autoBackup(), 300000);
                this.createBackup();
            },

            loadCategories() {
                const saved = localStorage.getItem('uts-categories');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            this.categories = parsed;
                        }
                    } catch (e) {
                        console.error('Error loading categories:', e);
                    }
                }
            },

            saveCategories() {
                localStorage.setItem('uts-categories', JSON.stringify(this.categories));
            },

            addCategory() {
                const name = prompt('Enter new category name:');
                if (!name || !name.trim()) return;
                
                const trimmed = name.trim();
                if (this.categories.includes(trimmed)) {
                    alert('Category already exists!');
                    return;
                }
                
                this.categories.push(trimmed);
                this.saveCategories();
                this.showNotification('Category added!');
                this.render();
            },

            deleteCategory(category) {
                if (category === 'All') {
                    alert('Cannot delete "All" category');
                    return;
                }
                
                const hasItems = this.items.some(item => item.category === category);
                if (hasItems) {
                    alert('Cannot delete category with items in it. Please move or delete those items first.');
                    return;
                }
                
                if (!confirm(`Delete category "${category}"?`)) return;
                
                this.categories = this.categories.filter(c => c !== category);
                this.saveCategories();
                this.showNotification('Category deleted');
                this.render();
            },

            validateData(data) {
                if (!Array.isArray(data)) return false;
                for (let item of data) {
                    if (!item.name || typeof item.name !== 'string') return false;
                    if (typeof item.quantity !== 'number') return false;
                }
                return true;
            },

            createBackup() {
                try {
                    const timestamp = new Date().toISOString();
                    const backup = {
                        items: this.items,
                        usageHistory: this.usageHistory,
                        projectFoods: this.projectFoods,
                        categories: this.categories,
                        timestamp: timestamp,
                        version: '2.1'
                    };
                    const backups = this.getBackups();
                    backups.push(backup);
                    if (backups.length > this.backupCount) backups.shift();
                    localStorage.setItem('uts-inventory-backups', JSON.stringify(backups));
                    console.log('Backup created:', timestamp);
                } catch (e) {
                    console.error('Backup creation failed:', e);
                }
            },

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-inventory-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

            restoreFromBackup() {
                const backups = this.getBackups();
                for (let i = backups.length - 1; i >= 0; i--) {
                    const backup = backups[i];
                    if (backup.items && this.validateData(backup.items)) {
                        this.items = backup.items;
                        this.usageHistory = backup.usageHistory || [];
                        this.projectFoods = backup.projectFoods || [];
                        if (backup.categories) this.categories = backup.categories;
                        this.showNotification('Restored from backup: ' + new Date(backup.timestamp).toLocaleString(), 'success');
                        return true;
                    }
                }
                this.showNotification('No valid backups found', 'error');
                return false;
            },

            autoBackup() {
                if (!this.validateData(this.items)) {
                    console.error('Data validation failed - backup skipped');
                    return;
                }
                this.createBackup();
            },

            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            },

            async loadData() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-inventory');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (this.validateData(parsed)) {
                                this.items = parsed;
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        } catch (e) {
                            this.restoreFromBackup();
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').select('*').order('name');
                        if (error) {
                            console.error('Supabase load error:', error);
                            throw error;
                        }
                        if (data) {
                            if (this.validateData(data)) {
                                this.items = data;
                                localStorage.setItem('uts-inventory', JSON.stringify(data));
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        }
                    } catch (e) {
                        console.error('Error loading from database:', e);
                        const saved = localStorage.getItem('uts-inventory');
                        if (saved) {
                            try {
                                this.items = JSON.parse(saved);
                            } catch (parseError) {
                                this.restoreFromBackup();
                            }
                        }
                    }
                }
                this.render();
            },

            loadUsageHistory() {
                const saved = localStorage.getItem('uts-usage-history');
                if (saved) {
                    try {
                        this.usageHistory = JSON.parse(saved);
                    } catch (e) {
                        this.usageHistory = [];
                    }
                }
            },

            saveUsageHistory() {
                localStorage.setItem('uts-usage-history', JSON.stringify(this.usageHistory));
            },

            recordUsage(itemId, itemName, change) {
                if (change < 0) {
                    this.usageHistory.push({
                        itemId: itemId,
                        itemName: itemName,
                        quantity: Math.abs(change),
                        timestamp: new Date().toISOString()
                    });
                    this.saveUsageHistory();
                }
            },

            loadProjectFoods() {
                const saved = localStorage.getItem('uts-project-foods');
                if (saved) {
                    try {
                        this.projectFoods = JSON.parse(saved);
                    } catch (e) {
                        this.projectFoods = [];
                    }
                }
            },

            saveProjectFoods() {
                localStorage.setItem('uts-project-foods', JSON.stringify(this.projectFoods));
            },

            async save() {
                localStorage.setItem('uts-inventory', JSON.stringify(this.items));
            },

            toggleAddForm() {
                const formVisible = document.getElementById('addForm')?.classList.contains('hidden') === false;
                this.editingItemId = null;
                this.render(!formVisible);
            },

            startEditItem(id) {
                this.editingItemId = id;
                this.render(true);
            },

            cancelEdit() {
                this.editingItemId = null;
                this.render(false);
            },

            async addItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                const item = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 0,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null
                };

                if (useLocalStorage) {
                    item.id = Date.now();
                    this.items.push(item);
                    await this.save();
                    this.createBackup();
                    this.showNotification('‚úì Item added successfully!');
                    this.toggleAddForm();
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').insert([item]).select();
                        if (error) {
                            console.error('Insert error:', error);
                            throw error;
                        }
                        await this.loadData();
                        this.showNotification('‚úì Item added successfully!');
                        this.toggleAddForm();
                    } catch (e) {
                        console.error('Full error:', e);
                        alert('Error saving item: ' + e.message);
                        return;
                    }
                }
            },

            async updateItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                const updatedItem = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 0,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null
                };

                if (useLocalStorage) {
                    const item = this.items.find(i => i.id === this.editingItemId);
                    if (item) {
                        Object.assign(item, updatedItem);
                        await this.save();
                        this.createBackup();
                    }
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update(updatedItem).eq('id', this.editingItemId);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating item: ' + e.message);
                        return;
                    }
                }

                this.showNotification('‚úì Item updated!');
                this.editingItemId = null;
                this.render(false);
            },

            async updateQuantity(id, change) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;

                const newQty = Math.max(0, item.quantity + change);
                this.recordUsage(id, item.name, change);

                if (useLocalStorage) {
                    item.quantity = newQty;
                    await this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating quantity: ' + e.message);
                    }
                }
            },

            async deleteItem(id) {
                if (!confirm('Remove this item from inventory?')) return;

                if (useLocalStorage) {
                    this.items = this.items.filter(i => i.id !== id);
                    await this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').delete().eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error deleting item: ' + e.message);
                    }
                }
                this.showNotification('Item deleted');
            },

            getItemStatus(item) {
                if (item.quantity === 0 && (item.minstock || 0) > 0) return { color: 'bg-red-100 border-red-300', text: 'OUT OF STOCK' };
                if ((item.minstock || 0) > 0 && item.quantity <= item.minstock) return { color: 'bg-orange-100 border-orange-300', text: 'LOW STOCK' };
                
                if (item.expirydate) {
                    const days = Math.ceil((new Date(item.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (days < 0) return { color: 'bg-red-100 border-red-300', text: 'EXPIRED' };
                    if (days <= 7) return { color: 'bg-yellow-100 border-yellow-300', text: `EXPIRES IN ${days}D` };
                }
                
                return { color: 'bg-white border-gray-200', text: '' };
            },

            exportToCSV() {
                const rows = [['Name', 'Category', 'Quantity', 'Unit', 'Min Stock', 'Location', 'Expiry Date', 'Status', 'Notes']];
                
                this.items.forEach(item => {
                    const status = this.getItemStatus(item);
                    rows.push([
                        item.name,
                        item.category,
                        item.quantity,
                        item.unit,
                        item.minstock || 0,
                        item.location || '',
                        item.expirydate || '',
                        status.text,
                        item.notes || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported successfully!');
            },

            generateShoppingList() {
                const needsRestock = this.items.filter(item => (item.minstock || 0) > 0 && item.quantity <= item.minstock);
                return needsRestock.sort((a, b) => a.category.localeCompare(b.category));
            },

            emailShoppingList() {
                const list = this.generateShoppingList();
                let body = 'UTS Inventory Shopping List\n\n';
                body += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                const byCategory = {};
                list.forEach(item => {
                    if (!byCategory[item.category]) byCategory[item.category] = [];
                    byCategory[item.category].push(item);
                });
                
                Object.keys(byCategory).sort().forEach(category => {
                    body += `${category}:\n`;
                    byCategory[category].forEach(item => {
                        body += `  ‚Ä¢ ${item.name} - Current: ${item.quantity} ${item.unit}, Need: ${item.minstock} ${item.unit}\n`;
                    });
                    body += '\n';
                });
                
                const mailto = `mailto:operations@underthestars.org.nz?subject=UTS Shopping List - ${new Date().toLocaleDateString()}&body=${encodeURIComponent(body)}`;
                window.location.href = mailto;
            },

            downloadShoppingList() {
                const list = this.generateShoppingList();
                const rows = [['Item', 'Category', 'Current Stock', 'Min Stock', 'Location']];
                
                list.forEach(item => {
                    rows.push([
                        item.name,
                        item.category,
                        `${item.quantity} ${item.unit}`,
                        `${item.minstock} ${item.unit}`,
                        item.location || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-shopping-list-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Shopping list downloaded!');
            },

            getConsumptionReport() {
                const last30Days = new Date();
                last30Days.setDate(last30Days.getDate() - 30);
                
                const recentUsage = this.usageHistory.filter(h => new Date(h.timestamp) >= last30Days);
                
                const byItem = {};
                recentUsage.forEach(usage => {
                    if (!byItem[usage.itemName]) {
                        byItem[usage.itemName] = { total: 0, count: 0 };
                    }
                    byItem[usage.itemName].total += usage.quantity;
                    byItem[usage.itemName].count++;
                });
                
                return Object.keys(byItem).map(itemName => ({
                    itemName,
                    totalUsed: byItem[itemName].total,
                    timesUsed: byItem[itemName].count,
                    avgPerUse: (byItem[itemName].total / byItem[itemName].count).toFixed(1)
                })).sort((a, b) => b.totalUsed - a.totalUsed);
            },

            addProjectFood() {
                const name = document.getElementById('projectFoodName').value.trim();
                const cost = parseFloat(document.getElementById('projectFoodCost').value);
                const date = document.getElementById('projectFoodDate').value;
                const project = document.getElementById('projectFoodProject').value.trim();
                
                if (!name || !cost || !date || !project) return alert('Please fill all fields');
                
                this.projectFoods.push({
                    id: Date.now(),
                    name: name,
                    cost: cost,
                    date: date,
                    project: project,
                    timestamp: new Date().toISOString()
                });
                
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Project food cost added!');
                
                document.getElementById('projectFoodName').value = '';
                document.getElementById('projectFoodCost').value = '';
                document.getElementById('projectFoodDate').value = '';
                document.getElementById('projectFoodProject').value = '';
                
                this.render();
            },

            deleteProjectFood(id) {
                if (!confirm('Delete this project food entry?')) return;
                this.projectFoods = this.projectFoods.filter(p => p.id !== id);
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Entry deleted');
                this.render();
            },

            loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.currentView = 'admin';
                    this.render();
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

            logoutAdmin() {
                this.isAdmin = false;
                this.currentView = 'inventory';
                this.render();
            },

            downloadBackup() {
                const backup = {
                    items: this.items,
                    usageHistory: this.usageHistory,
                    projectFoods: this.projectFoods,
                    categories: this.categories,
                    timestamp: new Date().toISOString(),
                    version: '2.1'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.items && this.validateData(backup.items)) {
                                this.items = backup.items;
                                this.usageHistory = backup.usageHistory || [];
                                this.projectFoods = backup.projectFoods || [];
                                if (backup.categories) this.categories = backup.categories;
                                this.save();
                                this.saveUsageHistory();
                                this.saveProjectFoods();
                                this.saveCategories();
                                this.createBackup();
                                this.showNotification('Backup restored successfully!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            render(showAddForm = false) {
                const appEl = document.getElementById('app');
                
                if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else {
                    appEl.innerHTML = this.renderInventory(showAddForm);
                }
            },

            renderAdmin() {
                const shoppingList = this.generateShoppingList();
                const consumption = this.getConsumptionReport();
                
                const projectTotals = {};
                this.projectFoods.forEach(p => {
                    if (!projectTotals[p.project]) {
                        projectTotals[p.project] = 0;
                    }
                    projectTotals[p.project] += p.cost;
                });
                const totalProjectCosts = this.projectFoods.reduce((sum, p) => sum + p.cost, 0);
                
                const stats = {
                    total: this.items.length,
                    lowStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity <= i.minstock && i.quantity > 0).length,
                    outOfStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity === 0).length,
                    expiringSoon: this.items.filter(i => {
                        if (!i.expirydate) return false;
                        const days = Math.ceil((new Date(i.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days >= 0 && days <= 7;
                    }).length
                };

                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-7xl mx-auto">
                            ${!useLocalStorage ? '<div class="bg-blue-100 text-blue-800 p-3 rounded mb-4 text-sm text-center font-semibold">‚úì Connected to Supabase Database</div>' : '<div class="bg-yellow-100 text-yellow-800 p-3 rounded mb-4 text-sm text-center font-semibold">‚ö† Using Local Storage Only</div>'}
                            
                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                                    <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                                    <div class="flex gap-2 flex-wrap">
                                        <button onclick="app.currentView='inventory'; app.render();" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 font-semibold">Back to Inventory</button>
                                        <button onclick="app.logoutAdmin()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 font-semibold">Logout</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
                                        <div class="text-sm text-gray-600">Total Items</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-orange-600">${stats.lowStock}</div>
                                        <div class="text-sm text-gray-600">Low Stock</div>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-red-600">${stats.outOfStock}</div>
                                        <div class="text-sm text-gray-600">Out of Stock</div>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-yellow-600">${stats.expiringSoon}</div>
                                        <div class="text-sm text-gray-600">Expiring Soon</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <button onclick="app.exportToCSV()" class="bg-green-600 text-white p-4 rounded-lg font-bold hover:bg-green-700">
                                        üìä Export Full Inventory
                                    </button>
                                    <button onclick="app.downloadBackup()" class="bg-blue-600 text-white p-4 rounded-lg font-bold hover:bg-blue-700">
                                        üíæ Download Backup
                                    </button>
                                    <button onclick="app.uploadBackup()" class="bg-orange-600 text-white p-4 rounded-lg font-bold hover:bg-orange-700">
                                        üì§ Restore Backup
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold">Manage Categories</h2>
                                    <button onclick="app.addCategory()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold">
                                        + Add Category
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${this.categories.filter(c => c !== 'All').map(cat => `
                                        <div class="flex items-center gap-2 bg-gray-100 px-3 py-2 rounded-lg">
                                            <span class="font-medium">${cat}</span>
                                            <button onclick="app.deleteCategory('${cat}')" class="text-red-600 hover:text-red-800 font-bold">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                                    <h2 class="text-2xl font-bold">Shopping List (${shoppingList.length} items)</h2>
                                    <div class="flex gap-2">
                                        <button onclick="app.downloadShoppingList()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold">
                                            üì• Download
                                        </button>
                                        <button onclick="app.emailShoppingList()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-semibold">
                                            üìß Email
                                        </button>
                                    </div>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    ${shoppingList.length === 0 ? '<p class="text-gray-500 text-center py-8">All items adequately stocked! üéâ</p>' : `
                                        <table class="w-full">
                                            <thead class="bg-gray-100 sticky top-0">
                                                <tr>
                                                    <th class="text-left p-2">Item</th>
                                                    <th class="text-left p-2">Category</th>
                                                    <th class="text-center p-2">Current</th>
                                                    <th class="text-center p-2">Min Stock</th>
                                                    <th class="text-left p-2">Location</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${shoppingList.map(item => `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-2 font-semibold">${item.name}</td>
                                                        <td class="p-2 text-sm text-gray-600">${item.category}</td>
                                                        <td class="p-2 text-center ${item.quantity === 0 ? 'text-red-600 font-bold' : 'text-orange-600'}">${item.quantity} ${item.unit}</td>
                                                        <td class="p-2 text-center">${item.minstock} ${item.unit}</td>
                                                        <td class="p-2 text-sm text-gray-600">${item.location || '-'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4">Consumption Patterns (Last 30 Days)</h2>
                                <div class="max-h-96 overflow-y-auto">
                                    ${consumption.length === 0 ? '<p class="text-gray-500 text-center py-8">No usage data yet</p>' : `
                                        <table class="w-full">
                                            <thead class="bg-gray-100 sticky top-0">
                                                <tr>
                                                    <th class="text-left p-2">Item</th>
                                                    <th class="text-center p-2">Total Used</th>
                                                    <th class="text-center p-2">Times Used</th>
                                                    <th class="text-center p-2">Avg per Use</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${consumption.map(item => `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-2 font-semibold">${item.itemName}</td>
                                                        <td class="p-2 text-center">${item.totalUsed}</td>
                                                        <td class="p-2 text-center">${item.timesUsed}</td>
                                                        <td class="p-2 text-center">${item.avgPerUse}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-2xl font-bold mb-4">Project Food Costs</h2>
                                <div class="bg-green-50 p-4 rounded-lg mb-4">
                                    <div class="text-3xl font-bold text-green-600">${totalProjectCosts.toFixed(2)}</div>
                                    <div class="text-sm text-gray-600">Total Project Food Costs</div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <input type="text" id="projectFoodName" placeholder="Food item name" class="border rounded-lg px-4 py-3 text-lg">
                                    <input type="number" id="projectFoodCost" placeholder="Cost ($)" step="0.01" class="border rounded-lg px-4 py-3 text-lg">
                                    <input type="date" id="projectFoodDate" class="border rounded-lg px-4 py-3 text-lg">
                                    <input type="text" id="projectFoodProject" placeholder="Project name" class="border rounded-lg px-4 py-3 text-lg">
                                </div>
                                <button onclick="app.addProjectFood()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 mb-4 w-full md:w-auto text-lg">
                                    Add Cost
                                </button>

                                <div class="max-h-96 overflow-y-auto">
                                    ${this.projectFoods.length === 0 ? '<p class="text-gray-500 text-center py-8">No project food costs recorded yet</p>' : `
                                        <table class="w-full">
                                            <thead class="bg-gray-100 sticky top-0">
                                                <tr>
                                                    <th class="text-left p-2">Item</th>
                                                    <th class="text-left p-2">Project</th>
                                                    <th class="text-center p-2">Cost</th>
                                                    <th class="text-center p-2">Date</th>
                                                    <th class="text-center p-2">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${this.projectFoods.sort((a, b) => new Date(b.date) - new Date(a.date)).map(item => `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-2 font-semibold">${item.name}</td>
                                                        <td class="p-2 text-gray-600">${item.project}</td>
                                                        <td class="p-2 text-center text-green-600 font-bold">${item.cost.toFixed(2)}</td>
                                                        <td class="p-2 text-center">${new Date(item.date).toLocaleDateString()}</td>
                                                        <td class="p-2 text-center">
                                                            <button onclick="app.deleteProjectFood(${item.id})" class="text-red-600 hover:text-red-800 font-semibold">
                                                                Delete
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderInventory(showAddForm) {
                const searchTerm = document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
                const filtered = this.items.filter(item => {
                    const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                    const matchesCategory = this.selectedCategory === 'All' || item.category === this.selectedCategory;
                    return matchesSearch && matchesCategory;
                });

                const stats = {
                    total: this.items.length,
                    lowStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity <= i.minstock && i.quantity > 0).length,
                    outOfStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity === 0).length,
                    expiringSoon: this.items.filter(i => {
                        if (!i.expirydate) return false;
                        const days = Math.ceil((new Date(i.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days >= 0 && days <= 7;
                    }).length
                };

                const editingItem = this.editingItemId ? this.items.find(i => i.id === this.editingItemId) : null;

                return `
                    <div class="min-h-screen p-4 pb-20">
                        <div class="max-w-6xl mx-auto">
                            ${!useLocalStorage ? '<div class="bg-blue-100 text-blue-800 p-3 rounded-lg mb-4 text-sm text-center font-semibold">‚úì Connected to Supabase</div>' : '<div class="bg-yellow-100 text-yellow-800 p-3 rounded-lg mb-4 text-sm text-center font-semibold">‚ö† Local Storage Mode</div>'}
                            
                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                        </svg>
                                        <h1 class="text-3xl font-bold text-gray-800">UTS Inventory</h1>
                                    </div>
                                    <div class="flex gap-2 flex-wrap">
                                        ${this.isAdmin ? '<button onclick="app.currentView=\'admin\'; app.render();" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 text-sm">Admin</button>' : ''}
                                        ${!this.isAdmin ? '<button onclick="app.loginAdmin()" class="text-gray-400 hover:text-gray-600 text-sm px-3 py-2">Admin</button>' : ''}
                                        <button onclick="app.exportData()" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 text-sm">Export</button>
                                        <button onclick="app.toggleAddForm()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">+ Add</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
                                        <div class="text-sm text-gray-600">Total Items</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-orange-600">${stats.lowStock}</div>
                                        <div class="text-sm text-gray-600">Low Stock</div>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-red-600">${stats.outOfStock}</div>
                                        <div class="text-sm text-gray-600">Out of Stock</div>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-yellow-600">${stats.expiringSoon}</div>
                                        <div class="text-sm text-gray-600">Expiring Soon</div>
                                    </div>
                                </div>
                            </div>

                            <div id="addForm" class="bg-white rounded-lg shadow-md p-6 mb-6 ${showAddForm ? '' : 'hidden'}">
                                <h2 class="text-xl font-bold mb-4">${editingItem ? '‚úèÔ∏è Edit Item' : '‚ûï Add New Item'}</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <input type="text" id="itemName" placeholder="Item name *" value="${editingItem ? editingItem.name : ''}" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                    <select id="itemCategory" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                        ${this.categories.filter(c => c !== 'All').map(cat => `<option value="${cat}" ${editingItem && editingItem.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                    </select>
                                    <input type="number" id="itemQuantity" placeholder="Quantity" value="${editingItem ? editingItem.quantity : '0'}" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                    <select id="itemUnit" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                        <option value="units" ${editingItem && editingItem.unit === 'units' ? 'selected' : ''}>units</option>
                                        <option value="kg" ${editingItem && editingItem.unit === 'kg' ? 'selected' : ''}>kg</option>
                                        <option value="g" ${editingItem && editingItem.unit === 'g' ? 'selected' : ''}>g</option>
                                        <option value="liters" ${editingItem && editingItem.unit === 'liters' ? 'selected' : ''}>liters</option>
                                        <option value="boxes" ${editingItem && editingItem.unit === 'boxes' ? 'selected' : ''}>boxes</option>
                                        <option value="bags" ${editingItem && editingItem.unit === 'bags' ? 'selected' : ''}>bags</option>
                                        <option value="cans" ${editingItem && editingItem.unit === 'cans' ? 'selected' : ''}>cans</option>
                                        <option value="packets" ${editingItem && editingItem.unit === 'packets' ? 'selected' : ''}>packets</option>
                                        <option value="bottles" ${editingItem && editingItem.unit === 'bottles' ? 'selected' : ''}>bottles</option>
                                    </select>
                                    <input type="number" id="itemMinStock" placeholder="Min stock alert (0 = no alert)" value="${editingItem ? (editingItem.minstock || 0) : '0'}" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                    <input type="date" id="itemExpiry" value="${editingItem && editingItem.expirydate ? editingItem.expirydate : ''}" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                    <input type="text" id="itemLocation" placeholder="Storage location" value="${editingItem && editingItem.location ? editingItem.location : ''}" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                    <textarea id="itemNotes" placeholder="Notes (optional)" class="border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg" rows="1">${editingItem && editingItem.notes ? editingItem.notes : ''}</textarea>
                                </div>
                                <div class="flex gap-3 flex-wrap">
                                    ${editingItem ? `
                                        <button onclick="app.updateItem()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 text-lg">
                                            ‚úì Save Changes
                                        </button>
                                        <button onclick="app.cancelEdit()" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-600 text-lg">
                                            Cancel
                                        </button>
                                    ` : `
                                        <button onclick="app.addItem()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 text-lg">
                                            ‚úì Add Item
                                        </button>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex flex-col md:flex-row gap-4 mb-4">
                                    <div class="flex-1 relative">
                                        <svg class="absolute left-3 top-3 text-gray-400 w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                        <input type="text" id="searchInput" placeholder="Search items..." oninput="app.render()" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg">
                                    </div>
                                </div>
                                <div class="text-sm font-semibold text-gray-600 mb-3">Filter by Category:</div>
                                <div class="flex gap-2 overflow-x-auto pb-2">
                                    ${this.categories.map(cat => `
                                        <button onclick="app.selectedCategory='${cat}'; app.render()" 
                                            class="px-4 py-2 rounded-lg text-base font-medium whitespace-nowrap transition ${
                                                this.selectedCategory === cat
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }">
                                            ${cat}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="space-y-4">
                                ${filtered.length === 0 ? `
                                    <div class="bg-white rounded-lg shadow-md p-12 text-center">
                                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                        </svg>
                                        <p class="text-gray-500 text-lg">
                                            ${this.items.length === 0 ? 'No items yet. Click "+ Add" to get started!' : 'No items match your search.'}
                                        </p>
                                    </div>
                                ` : filtered.map(item => {
                                    const status = this.getItemStatus(item);
                                    return `
                                        <div class="${status.color} border-2 rounded-lg p-5 transition hover:shadow-lg">
                                            <div class="flex flex-col gap-4">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                                                        <h3 class="text-xl font-bold text-gray-800">${item.name}</h3>
                                                        <span class="text-xs px-3 py-1 bg-gray-200 rounded-full text-gray-600 font-semibold">${item.category}</span>
                                                        ${item.location ? `<span class="text-xs px-3 py-1 bg-blue-100 rounded-full text-blue-700 font-semibold">üìç ${item.location}</span>` : ''}
                                                    </div>
                                                    <div class="flex flex-wrap gap-4 text-base text-gray-600 mb-2">
                                                        <span class="font-bold text-lg">
                                                            Stock: <span class="${item.quantity === 0 && (item.minstock || 0) > 0 ? 'text-red-600' : 'text-gray-800'}">${item.quantity} ${item.unit}</span>
                                                        </span>
                                                        ${item.expirydate ? `<span>Expires: ${new Date(item.expirydate).toLocaleDateString()}</span>` : ''}
                                                    </div>
                                                    ${item.notes ? `<p class="text-sm text-gray-600 italic mb-2">üìù ${item.notes}</p>` : ''}
                                                    ${status.text ? `
                                                        <div class="flex items-center gap-1 mt-2 bg-orange-50 px-3 py-2 rounded-lg inline-flex">
                                                            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                            </svg>
                                                            <span class="text-sm font-bold text-orange-700">${status.text}</span>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                
                                                <div class="grid grid-cols-2 gap-2">
                                                    <button onclick="app.updateQuantity(${item.id}, -10)" class="bg-red-600 text-white px-3 py-3 rounded-lg hover:bg-red-700 font-bold text-base">
                                                        -10
                                                    </button>
                                                    <button onclick="app.updateQuantity(${item.id}, -5)" class="bg-red-500 text-white px-3 py-3 rounded-lg hover:bg-red-600 font-bold text-base">
                                                        -5
                                                    </button>
                                                    <button onclick="app.updateQuantity(${item.id}, -1)" class="bg-red-400 text-white px-3 py-3 rounded-lg hover:bg-red-500 font-bold text-base">
                                                        -1
                                                    </button>
                                                    <button onclick="app.updateQuantity(${item.id}, 1)" class="bg-green-400 text-white px-3 py-3 rounded-lg hover:bg-green-500 font-bold text-base">
                                                        +1
                                                    </button>
                                                    <button onclick="app.updateQuantity(${item.id}, 5)" class="bg-green-500 text-white px-3 py-3 rounded-lg hover:bg-green-600 font-bold text-base">
                                                        +5
                                                    </button>
                                                    <button onclick="app.updateQuantity(${item.id}, 10)" class="bg-green-600 text-white px-3 py-3 rounded-lg hover:bg-green-700 font-bold text-base">
                                                        +10
                                                    </button>
                                                </div>
                                                
                                                <div class="flex gap-2">
                                                    <button onclick="app.startEditItem(${item.id})" class="flex-1 bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 font-bold text-base flex items-center justify-center gap-2">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                        Edit
                                                    </button>
                                                    <button onclick="app.deleteItem(${item.id})" class="flex-1 bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 font-bold text-base flex items-center justify-center gap-2">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            exportData() {
                this.exportToCSV();
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
