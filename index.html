<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTS Inventory & Recipe Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .quantity-dropdown {
            display: none;
        }
        .quantity-dropdown.active {
            display: grid;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        /*
        ============================================
        SUPABASE SETUP FOR CROSS-DEVICE SYNC
        ============================================
        
        For recipe sync, create this table in Supabase SQL Editor:
        
        CREATE TABLE recipe_projects (
            id BIGINT PRIMARY KEY,
            name TEXT NOT NULL,
            recipes JSONB DEFAULT '[]'::jsonb,
            created_at TIMESTAMPTZ DEFAULT NOW(),
            archived BOOLEAN DEFAULT FALSE,
            notes TEXT
        );
        
        ALTER TABLE recipe_projects ENABLE ROW LEVEL SECURITY;
        
        CREATE POLICY "Enable all access" ON recipe_projects FOR ALL USING (true);
        ============================================
        */
        
        const SUPABASE_URL = 'https://slelvrwtokiqlhletpsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZWx2cnd0b2tpcWxobGV0cHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODM3MTEsImV4cCI6MjA3NzM1OTcxMX0.mvO2vGyMlvmeV0tn60RL9dbzKkScBfXcFqMY-rTBmHM';
        const ADMIN_PASSWORD = 'UTS2025Admin';
        
        let supabase = null;
        let useLocalStorage = true;

        if (SUPABASE_URL && SUPABASE_KEY) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                useLocalStorage = false;
                console.log('Supabase connected successfully');
            } catch (e) {
                console.log('Supabase connection failed, using local storage:', e);
                useLocalStorage = true;
            }
        }

        function toggleQuantityDropdown(id) {
            const dropdown = document.getElementById(`qty-${id}`);
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        const app = {
            items: [],
            usageHistory: [],
            projectFoods: [],
            recipeProjects: [],
            selectedCategory: 'All',
            currentView: 'inventory',
            recipeView: 'active',
            selectedProjectId: null,
            isAdmin: false,
            backupCount: 10,
            editingItemId: null,
            compactView: false,
            filterStatus: null, // 'low', 'out', 'expiring', or null
            categories: ['All', 'Pasta/Grain', 'Canned Goods', 'Disposables', 'Equipment', 'Baking', 'Condiments', 'Stocks/Gravies', 'Seasoning', 'Bread', 'Frozen Meat', 'Prepared Meals', 'Frozen Veg', 'Fresh Fruit', 'Fresh Veg', 'Dairy', 'Baked Goods', 'Giveaways', 'Toiletries', 'Showers', 'Misc'],
            undoStack: [],

            async init() {
                this.loadCategories();
                await this.loadData();
                this.loadUsageHistory();
                this.loadProjectFoods();
                this.loadRecipeProjects();
                
                // Handle browser back/forward buttons
                window.addEventListener('popstate', (event) => {
                    if (event.state) {
                        this.currentView = event.state.view || 'inventory';
                        this.recipeView = event.state.recipeView || 'active';
                        this.selectedProjectId = event.state.selectedProjectId || null;
                        this.render();
                    }
                });
                
                // Set initial state
                history.replaceState({
                    view: this.currentView,
                    recipeView: this.recipeView,
                    selectedProjectId: this.selectedProjectId
                }, '');
                
                this.render();
                
                if (!useLocalStorage && supabase) {
                    try {
                        // Subscribe to inventory changes
                        supabase.channel('inventory_changes').on('postgres_changes', 
                            { event: '*', schema: 'public', table: 'inventory' }, 
                            () => this.loadData()
                        ).subscribe();
                        
                        // Subscribe to recipe project changes
                        supabase.channel('recipe_project_changes').on('postgres_changes',
                            { event: '*', schema: 'public', table: 'recipe_projects' },
                            () => this.loadRecipeProjects()
                        ).subscribe();
                    } catch (e) {
                        console.log('Real-time subscription failed:', e);
                    }
                }
                
                setInterval(() => this.autoBackup(), 300000);
                this.createBackup();
            },

            navigateTo(view, recipeView = null, projectId = null) {
                this.currentView = view;
                if (recipeView) this.recipeView = recipeView;
                if (projectId !== null) this.selectedProjectId = projectId;
                
                // Add to browser history so back button works
                history.pushState({
                    view: this.currentView,
                    recipeView: this.recipeView,
                    selectedProjectId: this.selectedProjectId
                }, '');
                
                this.render();
            },

            loadCategories() {
                const saved = localStorage.getItem('uts-categories');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            this.categories = parsed;
                        }
                    } catch (e) {
                        console.error('Error loading categories:', e);
                    }
                }
            },

            saveCategories() {
                localStorage.setItem('uts-categories', JSON.stringify(this.categories));
            },

            addCategory() {
                const name = prompt('Enter new category name:');
                if (!name || !name.trim()) return;
                
                const trimmed = name.trim();
                if (this.categories.includes(trimmed)) {
                    alert('Category already exists!');
                    return;
                }
                
                this.categories.push(trimmed);
                this.saveCategories();
                this.showNotification('Category added!');
                this.render();
            },

            deleteCategory(category) {
                if (category === 'All') {
                    alert('Cannot delete "All" category');
                    return;
                }
                
                const hasItems = this.items.some(item => item.category === category);
                if (hasItems) {
                    alert('Cannot delete category with items in it. Please move or delete those items first.');
                    return;
                }
                
                if (!confirm(`Delete category "${category}"?`)) return;
                
                this.categories = this.categories.filter(c => c !== category);
                this.saveCategories();
                this.showNotification('Category deleted');
                this.render();
            },

            validateData(data) {
                if (!Array.isArray(data)) return false;
                for (let item of data) {
                    if (!item.name || typeof item.name !== 'string') return false;
                    if (typeof item.quantity !== 'number') return false;
                }
                return true;
            },

            createBackup() {
                try {
                    const timestamp = new Date().toISOString();
                    const backup = {
                        items: this.items,
                        usageHistory: this.usageHistory,
                        projectFoods: this.projectFoods,
                        recipeProjects: this.recipeProjects,
                        categories: this.categories,
                        timestamp: timestamp,
                        version: '3.0'
                    };
                    const backups = this.getBackups();
                    backups.push(backup);
                    if (backups.length > this.backupCount) backups.shift();
                    localStorage.setItem('uts-inventory-backups', JSON.stringify(backups));
                    console.log('Backup created:', timestamp);
                } catch (e) {
                    console.error('Backup creation failed:', e);
                }
            },

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-inventory-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

            restoreFromBackup() {
                const backups = this.getBackups();
                for (let i = backups.length - 1; i >= 0; i--) {
                    const backup = backups[i];
                    if (backup.items && this.validateData(backup.items)) {
                        this.items = backup.items;
                        this.usageHistory = backup.usageHistory || [];
                        this.projectFoods = backup.projectFoods || [];
                        this.recipeProjects = backup.recipeProjects || [];
                        if (backup.categories) this.categories = backup.categories;
                        this.showNotification('Restored from backup: ' + new Date(backup.timestamp).toLocaleString());
                        return true;
                    }
                }
                this.showNotification('No valid backups found', 'error');
                return false;
            },

            autoBackup() {
                if (!this.validateData(this.items)) {
                    console.error('Data validation failed - backup skipped');
                    return;
                }
                this.createBackup();
            },

            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 fade-in ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white font-semibold max-w-md`;
                notif.style.whiteSpace = 'pre-line'; // Preserve line breaks
                notif.textContent = message;
                document.body.appendChild(notif);
                
                // Longer timeout for longer messages
                const timeout = message.length > 100 ? 5000 : 3000;
                setTimeout(() => notif.remove(), timeout);
            },

            async loadData() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-inventory');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (this.validateData(parsed)) {
                                this.items = parsed;
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        } catch (e) {
                            this.restoreFromBackup();
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').select('*').order('name');
                        if (error) throw error;
                        if (data) {
                            if (this.validateData(data)) {
                                this.items = data;
                                localStorage.setItem('uts-inventory', JSON.stringify(data));
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        }
                    } catch (e) {
                        console.error('Error loading from database:', e);
                        const saved = localStorage.getItem('uts-inventory');
                        if (saved) {
                            try {
                                this.items = JSON.parse(saved);
                            } catch (parseError) {
                                this.restoreFromBackup();
                            }
                        }
                    }
                }
                this.render();
            },

            loadUsageHistory() {
                const saved = localStorage.getItem('uts-usage-history');
                if (saved) {
                    try {
                        this.usageHistory = JSON.parse(saved);
                    } catch (e) {
                        this.usageHistory = [];
                    }
                }
            },

            saveUsageHistory() {
                localStorage.setItem('uts-usage-history', JSON.stringify(this.usageHistory));
            },

            recordUsage(itemId, itemName, change) {
                if (change !== 0) {
                    const item = this.items.find(i => i.id === itemId);
                    if (item) {
                        item.lastUpdated = new Date().toISOString();
                    }
                }
                if (change < 0) {
                    this.usageHistory.push({
                        itemId: itemId,
                        itemName: itemName,
                        quantity: Math.abs(change),
                        timestamp: new Date().toISOString()
                    });
                    this.saveUsageHistory();
                }
            },

            loadProjectFoods() {
                const saved = localStorage.getItem('uts-project-foods');
                if (saved) {
                    try {
                        this.projectFoods = JSON.parse(saved);
                    } catch (e) {
                        this.projectFoods = [];
                    }
                }
            },

            saveProjectFoods() {
                localStorage.setItem('uts-project-foods', JSON.stringify(this.projectFoods));
            },

            loadRecipeProjects() {
                if (!useLocalStorage && supabase) {
                    this.loadRecipeProjectsFromSupabase();
                } else {
                    const saved = localStorage.getItem('uts-recipe-projects');
                    if (saved) {
                        try {
                            this.recipeProjects = JSON.parse(saved);
                        } catch (e) {
                            this.recipeProjects = [];
                        }
                    }
                }
            },

            async loadRecipeProjectsFromSupabase() {
                try {
                    const { data, error } = await supabase
                        .from('recipe_projects')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('Error loading recipe projects from Supabase:', error);
                        // Fallback to localStorage
                        this.loadRecipeProjects();
                        return;
                    }
                    
                    if (data) {
                        this.recipeProjects = data.map(project => ({
                            id: project.id,
                            name: project.name,
                            recipes: project.recipes || [],
                            createdAt: project.created_at,
                            archived: project.archived || false,
                            notes: project.notes || ''
                        }));
                        // Also save to localStorage as backup
                        localStorage.setItem('uts-recipe-projects', JSON.stringify(this.recipeProjects));
                    }
                } catch (e) {
                    console.error('Exception loading from Supabase:', e);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('uts-recipe-projects');
                    if (saved) {
                        try {
                            this.recipeProjects = JSON.parse(saved);
                        } catch (parseError) {
                            this.recipeProjects = [];
                        }
                    }
                }
            },

            saveRecipeProjects() {
                localStorage.setItem('uts-recipe-projects', JSON.stringify(this.recipeProjects));
                
                if (!useLocalStorage && supabase) {
                    this.saveRecipeProjectsToSupabase();
                }
                
                this.createBackup();
            },

            async saveRecipeProjectsToSupabase() {
                try {
                    // Save each project
                    for (const project of this.recipeProjects) {
                        const projectData = {
                            id: project.id,
                            name: project.name,
                            recipes: project.recipes,
                            created_at: project.createdAt,
                            archived: project.archived,
                            notes: project.notes || ''
                        };
                        
                        const { error } = await supabase
                            .from('recipe_projects')
                            .upsert(projectData);
                        
                        if (error) {
                            console.error('Error saving project to Supabase:', error);
                        }
                    }
                } catch (e) {
                    console.error('Exception saving to Supabase:', e);
                }
            },

            createNewProject() {
                const name = prompt('Enter project name (e.g., "Christmas Dinner 2024", "Weekly Meals - Week 1"):');
                if (!name || !name.trim()) return;
                
                const newProject = {
                    id: Date.now(),
                    name: name.trim(),
                    recipes: [],
                    createdAt: new Date().toISOString(),
                    archived: false,
                    notes: ''
                };
                
                this.recipeProjects.push(newProject);
                this.saveRecipeProjects();
                this.selectedProjectId = newProject.id;
                this.showNotification('✓ Project created!');
                this.render();
            },

            deleteProject(projectId) {
                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) return;
                
                if (!confirm(`Delete project "${project.name}" and all its recipes?`)) return;
                
                this.recipeProjects = this.recipeProjects.filter(p => p.id !== projectId);
                if (this.selectedProjectId === projectId) {
                    this.selectedProjectId = null;
                }
                this.saveRecipeProjects();
                this.showNotification('Project deleted');
                this.render();
            },

            archiveProject(projectId) {
                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) return;
                
                project.archived = !project.archived;
                this.saveRecipeProjects();
                this.showNotification(project.archived ? 'Project archived' : 'Project unarchived');
                this.render();
            },

            addManualRecipe(projectId) {
                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) return;

                const recipeName = prompt('Enter recipe name:');
                if (!recipeName || !recipeName.trim()) return;

                const servingsInput = prompt('Number of servings:', '50');
                const servings = parseInt(servingsInput) || 50;

                const newRecipe = {
                    id: Date.now(),
                    name: recipeName.trim(),
                    servings: servings,
                    originalServings: servings, // Store original for scaling
                    originalText: '',
                    ingredients: [],
                    createdAt: new Date().toISOString()
                };

                project.recipes.push(newRecipe);
                this.saveRecipeProjects();
                this.showNotification('✓ Recipe created! Now add ingredients.');
                this.render();
            },

            scaleRecipe(projectId, recipeId) {
                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) return;
                
                const recipe = project.recipes.find(r => r.id === recipeId);
                if (!recipe) return;

                const newServings = prompt(`Scale recipe to how many servings?\n\nCurrent: ${recipe.servings} servings\nOriginal: ${recipe.originalServings || recipe.servings} servings`, recipe.servings);
                if (!newServings || newServings === null) return;

                const servingsNum = parseInt(newServings);
                if (isNaN(servingsNum) || servingsNum <= 0) {
                    this.showNotification('Invalid number of servings', 'error');
                    return;
                }

                // Calculate scale factor
                const originalServings = recipe.originalServings || recipe.servings;
                const scaleFactor = servingsNum / originalServings;

                // Scale all ingredients
                recipe.ingredients = recipe.ingredients.map(ing => ({
                    ...ing,
                    quantity: Math.round(ing.quantity * scaleFactor * 100) / 100 // Round to 2 decimals
                }));

                recipe.servings = servingsNum;
                
                this.saveRecipeProjects();
                this.showNotification(`✓ Scaled from ${originalServings} to ${servingsNum} servings!`);
                this.render();
            },


            addIngredientToRecipe(projectId, recipeId) {
                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) return;
                
                const recipe = project.recipes.find(r => r.id === recipeId);
                if (!recipe) return;

                const name = prompt('Ingredient name:');
                if (!name || !name.trim()) return;

                const quantity = parseFloat(prompt('Quantity:'));
                if (isNaN(quantity)) return;

                const unit = prompt('Unit (kg, g, liters, cans, etc):');
                if (!unit || !unit.trim()) return;

                const category = prompt('Category:\n1=Pasta/Grain, 2=Canned Goods, 3=Dairy, 4=Fresh Veg, 5=Fresh Fruit\n6=Frozen Meat, 7=Frozen Veg, 8=Condiments, 9=Seasoning, 10=Baking, 11=Misc');
                const categories = ['Pasta/Grain', 'Canned Goods', 'Dairy', 'Fresh Veg', 'Fresh Fruit', 'Frozen Meat', 'Frozen Veg', 'Condiments', 'Seasoning', 'Baking', 'Misc'];
                const catIndex = parseInt(category) - 1;
                const selectedCategory = catIndex >= 0 && catIndex < categories.length ? categories[catIndex] : 'Misc';

                recipe.ingredients.push({
                    name: name.trim(),
                    quantity: quantity,
                    unit: unit.trim(),
                    category: selectedCategory,
                    checked: false
                });

                this.saveRecipeProjects();
                this.showNotification('✓ Ingredient added!');
                this.render();
            },

            async parseRecipe(projectId) {
                const input = document.getElementById(`recipeInput-${projectId}`).value;
                const servings = parseInt(document.getElementById(`recipeServings-${projectId}`).value) || 50;
                const recipeName = document.getElementById(`recipeName-${projectId}`).value.trim();

                if (!input.trim()) {
                    this.showNotification('Please paste ingredients first!', 'error');
                    return;
                }

                if (!recipeName) {
                    this.showNotification('Please enter a recipe name!', 'error');
                    return;
                }

                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) {
                    this.showNotification('Project not found!', 'error');
                    return;
                }

                // Parse the recipe
                const parsedRecipe = this.enhancedRecipeParser(input, servings, recipeName);
                
                if (parsedRecipe && parsedRecipe.ingredients.length > 0) {
                    project.recipes.push(parsedRecipe);
                    this.saveRecipeProjects();
                    
                    // Show what was extracted
                    const count = parsedRecipe.ingredients.length;
                    const lines = input.split('\n').filter(l => l.trim()).length;
                    this.showNotification(`✓ Recipe "${recipeName}" added!\n\nExtracted ${count} ingredients from ${lines} lines.`);
                    
                    // Clear form
                    document.getElementById(`recipeInput-${projectId}`).value = '';
                    document.getElementById(`recipeName-${projectId}`).value = '';
                    document.getElementById(`recipeServings-${projectId}`).value = '50';
                    document.getElementById(`autoparse-${projectId}`).classList.add('hidden');
                    
                    this.render();
                } else {
                    const lineCount = input.split('\n').filter(l => l.trim()).length;
                    this.showNotification(`❌ Found 0 ingredients from ${lineCount} lines!\n\nMake sure each line has:\n• A number (2, 500, 1.5)\n• A unit (kg, g, cans, cups)\n• The ingredient name\n\nExample: "2kg beef mince"\n\nOr use "Manual Entry" instead!`, 'error');
                }
            },

            previewParsing(projectId) {
                const input = document.getElementById(`recipeInput-${projectId}`).value;
                const servings = parseInt(document.getElementById(`recipeServings-${projectId}`).value) || 50;
                const recipeName = document.getElementById(`recipeName-${projectId}`).value.trim() || 'Preview';

                if (!input.trim()) {
                    this.showNotification('Please paste ingredients first!', 'error');
                    return;
                }

                // Parse without saving
                const parsedRecipe = this.enhancedRecipeParser(input, servings, recipeName);
                
                if (parsedRecipe && parsedRecipe.ingredients.length > 0) {
                    const ingredientList = parsedRecipe.ingredients.map((ing, i) => 
                        `${i+1}. ${ing.quantity} ${ing.unit} ${ing.name} (${ing.category})`
                    ).join('\n');
                    
                    const lineCount = input.split('\n').filter(l => l.trim()).length;
                    alert(`✓ PREVIEW: Found ${parsedRecipe.ingredients.length} ingredients from ${lineCount} lines:\n\n${ingredientList}\n\nLook good? Click "Extract & Add to Project" to save it!`);
                } else {
                    const lineCount = input.split('\n').filter(l => l.trim()).length;
                    alert(`❌ PREVIEW: Found 0 ingredients from ${lineCount} lines.\n\nCheck your formatting:\n• Each line needs a number\n• Then a unit (kg, g, cans, etc)\n• Then the ingredient name\n\nExample: "2kg beef mince"`);
                }
            },


            enhancedRecipeParser(text, servings, recipeName) {
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length === 0) return null;

                const ingredients = [];

                for (let line of lines) {
                    line = line.trim();
                    if (line.length < 2) continue;
                    
                    // Skip lines that look like headers or instructions
                    if (line.toLowerCase().startsWith('ingredient') || 
                        line.toLowerCase().startsWith('instruction') ||
                        line.toLowerCase().startsWith('method') ||
                        line.toLowerCase().startsWith('step')) continue;
                    
                    let quantity = null;
                    let unit = null;
                    let name = null;

                    // Try to extract numbers first (more flexible)
                    const numberMatch = line.match(/(\d+\.?\d*|\d*\.?\d+)/);
                    
                    if (numberMatch) {
                        quantity = parseFloat(numberMatch[1]);
                        
                        // Find unit words near the number
                        const unitWords = ['kg', 'g', 'gram', 'grams', 'kilogram', 'kilograms',
                                          'liter', 'liters', 'litre', 'litres', 'l', 'ml', 'milliliter', 'milliliters',
                                          'can', 'cans', 'tin', 'tins', 'box', 'boxes', 'packet', 'packets',
                                          'bottle', 'bottles', 'jar', 'jars',
                                          'cup', 'cups', 'c', 
                                          'tbsp', 'tablespoon', 'tablespoons', 'tsp', 'teaspoon', 'teaspoons',
                                          'piece', 'pieces', 'whole', 'unit', 'units',
                                          'clove', 'cloves', 'slice', 'slices',
                                          'lb', 'pound', 'pounds', 'oz', 'ounce', 'ounces'];
                        
                        // Look for unit after the number
                        const afterNumber = line.substring(numberMatch.index + numberMatch[0].length).toLowerCase();
                        for (let unitWord of unitWords) {
                            if (afterNumber.trim().startsWith(unitWord)) {
                                unit = unitWord;
                                // Get the name (everything after unit)
                                name = afterNumber.replace(new RegExp(`^\\s*${unitWord}\\s*`, 'i'), '').trim();
                                break;
                            }
                        }
                        
                        // If no unit found, maybe it's before the number?
                        if (!unit) {
                            const beforeNumber = line.substring(0, numberMatch.index).toLowerCase();
                            for (let unitWord of unitWords) {
                                if (beforeNumber.trim().endsWith(unitWord)) {
                                    unit = unitWord;
                                    // Name is after the number
                                    name = afterNumber.trim();
                                    break;
                                }
                            }
                        }
                        
                        // Still no unit? Default to 'units' and name is everything except number
                        if (!unit) {
                            unit = 'units';
                            name = line.replace(numberMatch[0], '').trim();
                        }
                    } else {
                        // No number found - skip this line
                        continue;
                    }
                    
                    // Clean up the name
                    if (name) {
                        // Remove common prefixes/bullet points
                        name = name.replace(/^[\-\*•●○]\s*/, '');
                        // Remove parentheses content
                        name = name.replace(/\([^)]*\)/g, '');
                        // Remove commas and everything after
                        name = name.split(',')[0];
                        // Remove dashes and everything after (like "- diced")
                        if (name.includes(' - ')) {
                            name = name.split(' - ')[0];
                        }
                        name = name.trim();
                    }
                    
                    if (quantity && unit && name && name.length > 0) {
                        // Normalize unit
                        unit = this.normalizeUnit(unit);
                        
                        // Categorize
                        const category = this.categorizeIngredient(name);
                        
                        ingredients.push({
                            name: name,
                            quantity: quantity,
                            unit: unit,
                            category: category,
                            checked: false
                        });
                    }
                }

                if (ingredients.length === 0) return null;

                return {
                    id: Date.now(),
                    name: recipeName,
                    servings: servings,
                    originalServings: servings, // Store original for scaling
                    originalText: text,
                    ingredients: ingredients,
                    createdAt: new Date().toISOString()
                };
            },

            normalizeUnit(unit) {
                unit = unit.toLowerCase().trim();
                
                // Weight
                if (unit === 'g' || unit === 'gram' || unit === 'grams') return 'g';
                if (unit === 'kg' || unit === 'kilogram' || unit === 'kilograms') return 'kg';
                if (unit === 'lb' || unit === 'pound' || unit === 'pounds') return 'lb';
                if (unit === 'oz' || unit === 'ounce' || unit === 'ounces') return 'oz';
                
                // Volume
                if (unit === 'liter' || unit === 'liters' || unit === 'litre' || unit === 'litres' || unit === 'l') return 'liters';
                if (unit === 'ml' || unit === 'milliliter' || unit === 'milliliters') return 'ml';
                if (unit === 'cup' || unit === 'cups' || unit === 'c') return 'cups';
                
                // Containers
                if (unit === 'can' || unit === 'cans' || unit === 'tin' || unit === 'tins') return 'cans';
                if (unit === 'box' || unit === 'boxes') return 'boxes';
                if (unit === 'packet' || unit === 'packets') return 'packets';
                if (unit === 'bottle' || unit === 'bottles') return 'bottles';
                if (unit === 'jar' || unit === 'jars') return 'jars';
                
                // Measurements
                if (unit === 'tablespoon' || unit === 'tablespoons' || unit === 'tbsp') return 'tbsp';
                if (unit === 'teaspoon' || unit === 'teaspoons' || unit === 'tsp') return 'tsp';
                
                // Pieces
                if (unit === 'piece' || unit === 'pieces' || unit === 'unit' || unit === 'units') return 'units';
                if (unit === 'whole') return 'whole';
                if (unit === 'clove' || unit === 'cloves') return 'cloves';
                if (unit === 'slice' || unit === 'slices') return 'slices';
                
                return unit;
            },

            categorizeIngredient(name) {
                const nameLower = name.toLowerCase();
                
                // Comprehensive categorization
                if (nameLower.match(/pasta|spaghetti|macaroni|penne|rice|noodle|couscous|quinoa|grain/)) 
                    return 'Pasta/Grain';
                
                if (nameLower.match(/tomato|bean|corn|soup|canned|tinned|chickpea|lentil/)) 
                    return 'Canned Goods';
                
                if (nameLower.match(/milk|cheese|butter|cream|yogurt|yoghurt|sour cream/)) 
                    return 'Dairy';
                
                if (nameLower.match(/potato|onion|carrot|celery|lettuce|cabbage|broccoli|cauliflower|pepper|capsicum|zucchini|courgette|cucumber|tomato|eggplant|aubergine|spinach|kale/)) 
                    return 'Fresh Veg';
                
                if (nameLower.match(/apple|banana|orange|lemon|lime|berry|strawberry|blueberry|melon|grape|pear|peach|mango/)) 
                    return 'Fresh Fruit';
                
                if (nameLower.match(/chicken|beef|pork|lamb|meat|mince|ground|steak|sausage|bacon|ham/)) 
                    return 'Frozen Meat';
                
                if (nameLower.match(/peas|frozen.*veg|mixed.*veg/)) 
                    return 'Frozen Veg';
                
                if (nameLower.match(/salt|pepper|spice|cumin|paprika|oregano|basil|thyme|parsley|coriander|rosemary|garlic|ginger|chili|chilli/)) 
                    return 'Seasoning';
                
                if (nameLower.match(/oil|olive|sauce|vinegar|mayo|mayonnaise|ketchup|mustard|soy|stock|gravy/)) 
                    return 'Condiments';
                
                if (nameLower.match(/flour|sugar|baking|yeast|powder|vanilla/)) 
                    return 'Baking';
                
                if (nameLower.match(/bread|bun|roll|baguette|toast/)) 
                    return 'Bread';
                
                return 'Misc';
            },

            simpleRecipeParser(text, servings) {
                // Simple regex-based parser for common recipe formats
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length === 0) return null;

                const recipeName = lines[0].trim();
                const ingredients = [];

                // Enhanced patterns to catch more formats
                // Pattern 1: "2kg beef", "500g flour", "3 cans tomatoes"
                const pattern1 = /^[\s\-\*•]*(\d+\.?\d*)\s*(kg|g|liters?|ml|cans?|tins?|boxes?|packets?|bottles?|cups?|tbsp|tsp|tablespoons?|teaspoons?|pieces?|units?|cloves?|slices?)[\s,]*(.+?)$/i;
                
                // Pattern 2: "beef mince - 2kg", "flour - 500g"
                const pattern2 = /^[\s\-\*•]*(.+?)[\s\-]+(\d+\.?\d*)\s*(kg|g|liters?|ml|cans?|tins?|boxes?|packets?|bottles?|cups?|tbsp|tsp|pieces?|units?).*$/i;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.length < 3) continue; // Skip very short lines
                    
                    let match = line.match(pattern1);
                    let quantity, unit, name;
                    
                    if (match) {
                        quantity = parseFloat(match[1]);
                        unit = match[2].toLowerCase();
                        name = match[3].trim().replace(/[,\(\)].*/, '').trim();
                    } else {
                        match = line.match(pattern2);
                        if (match) {
                            name = match[1].trim();
                            quantity = parseFloat(match[2]);
                            unit = match[3].toLowerCase();
                        }
                    }
                    
                    if (match && !isNaN(quantity) && name && unit) {
                        // Normalize units
                        if (unit.includes('liter')) unit = 'liters';
                        if (unit.includes('can') || unit.includes('tin')) unit = 'cans';
                        if (unit === 'piece' || unit === 'pieces') unit = 'units';
                        if (unit === 'tablespoon' || unit === 'tablespoons') unit = 'tbsp';
                        if (unit === 'teaspoon' || unit === 'teaspoons') unit = 'tsp';
                        if (unit === 'clove' || unit === 'cloves') unit = 'cloves';
                        if (unit === 'slice' || unit === 'slices') unit = 'slices';

                        // Guess category based on keywords
                        let category = 'Misc';
                        const nameLower = name.toLowerCase();
                        
                        // More comprehensive categorization
                        if (nameLower.includes('pasta') || nameLower.includes('rice') || nameLower.includes('noodle') || 
                            nameLower.includes('spaghetti') || nameLower.includes('macaroni') || nameLower.includes('couscous')) {
                            category = 'Pasta/Grain';
                        }
                        else if (nameLower.includes('tomato') || nameLower.includes('bean') || nameLower.includes('corn') || 
                                 nameLower.includes('soup') || nameLower.includes('canned') || nameLower.includes('tinned')) {
                            category = 'Canned Goods';
                        }
                        else if (nameLower.includes('milk') || nameLower.includes('cheese') || nameLower.includes('butter') || 
                                 nameLower.includes('cream') || nameLower.includes('yogurt') || nameLower.includes('yoghurt')) {
                            category = 'Dairy';
                        }
                        else if (nameLower.includes('potato') || nameLower.includes('onion') || nameLower.includes('carrot') || 
                                 nameLower.includes('celery') || nameLower.includes('lettuce') || nameLower.includes('cabbage') ||
                                 nameLower.includes('broccoli') || nameLower.includes('cauliflower') || nameLower.includes('pepper') ||
                                 nameLower.includes('capsicum') || nameLower.includes('zucchini') || nameLower.includes('courgette')) {
                            category = 'Fresh Veg';
                        }
                        else if (nameLower.includes('apple') || nameLower.includes('banana') || nameLower.includes('orange') ||
                                 nameLower.includes('lemon') || nameLower.includes('lime') || nameLower.includes('berry') ||
                                 nameLower.includes('melon') || nameLower.includes('grape')) {
                            category = 'Fresh Fruit';
                        }
                        else if (nameLower.includes('chicken') || nameLower.includes('beef') || nameLower.includes('pork') || 
                                 nameLower.includes('lamb') || nameLower.includes('meat') || nameLower.includes('mince') ||
                                 nameLower.includes('steak') || nameLower.includes('sausage')) {
                            category = 'Frozen Meat';
                        }
                        else if (nameLower.includes('peas') || nameLower.includes('frozen veg')) {
                            category = 'Frozen Veg';
                        }
                        else if (nameLower.includes('salt') || nameLower.includes('pepper') || nameLower.includes('spice') ||
                                 nameLower.includes('cumin') || nameLower.includes('paprika') || nameLower.includes('oregano') ||
                                 nameLower.includes('basil') || nameLower.includes('thyme') || nameLower.includes('garlic') ||
                                 nameLower.includes('ginger')) {
                            category = 'Seasoning';
                        }
                        else if (nameLower.includes('oil') || nameLower.includes('sauce') || nameLower.includes('vinegar') ||
                                 nameLower.includes('mayo') || nameLower.includes('ketchup') || nameLower.includes('mustard') ||
                                 nameLower.includes('soy sauce') || nameLower.includes('stock')) {
                            category = 'Condiments';
                        }
                        else if (nameLower.includes('flour') || nameLower.includes('sugar') || nameLower.includes('baking') ||
                                 nameLower.includes('yeast') || nameLower.includes('powder')) {
                            category = 'Baking';
                        }
                        else if (nameLower.includes('bread') || nameLower.includes('bun') || nameLower.includes('roll')) {
                            category = 'Bread';
                        }

                        ingredients.push({
                            name: name,
                            quantity: quantity,
                            unit: unit,
                            category: category,
                            checked: false
                        });
                    }
                }

                if (ingredients.length === 0) return null;

                return {
                    id: Date.now(),
                    name: recipeName,
                    servings: servings,
                    originalText: text,
                    ingredients: ingredients,
                    createdAt: new Date().toISOString()
                };
            },

            deleteRecipe(projectId, recipeId) {
                if (!confirm('Delete this recipe?')) return;
                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) return;
                
                project.recipes = project.recipes.filter(r => r.id !== recipeId);
                this.saveRecipeProjects();
                this.showNotification('Recipe deleted');
                this.render();
            },

            toggleRecipeIngredient(projectId, recipeId, ingredientIndex) {
                const project = this.recipeProjects.find(p => p.id === projectId);
                if (!project) return;
                
                const recipe = project.recipes.find(r => r.id === recipeId);
                if (!recipe) return;
                
                recipe.ingredients[ingredientIndex].checked = !recipe.ingredients[ingredientIndex].checked;
                this.saveRecipeProjects();
                this.render();
            },

            checkInventoryForIngredient(ingredientName, ingredientUnit, neededQuantity = 0) {
                // Find matching item in inventory
                const match = this.items.find(item => 
                    item.name.toLowerCase().includes(ingredientName.toLowerCase()) ||
                    ingredientName.toLowerCase().includes(item.name.toLowerCase())
                );
                
                if (!match) return null;
                
                // Convert quantities to same unit for comparison
                const normalized = this.normalizeQuantities(
                    match.quantity, match.unit,
                    neededQuantity, ingredientUnit
                );
                
                if (!normalized) {
                    // Units don't match - just return basic info
                    return {
                        item: match,
                        inStock: match.quantity > 0,
                        enoughStock: false,
                        unitMismatch: true,
                        message: `Have ${match.quantity} ${match.unit}, need ${neededQuantity} ${ingredientUnit} (different units)`
                    };
                }
                
                const hasEnough = normalized.stockQuantity >= normalized.neededQuantity;
                const shortage = hasEnough ? 0 : normalized.neededQuantity - normalized.stockQuantity;
                
                return {
                    item: match,
                    inStock: match.quantity > 0,
                    enoughStock: hasEnough,
                    stockQuantity: normalized.stockQuantity,
                    neededQuantity: normalized.neededQuantity,
                    shortage: shortage,
                    unit: normalized.unit,
                    message: hasEnough 
                        ? `✓ Have ${match.quantity} ${match.unit}` 
                        : `⚠ Have ${match.quantity} ${match.unit}, need ${shortage.toFixed(1)} ${normalized.unit} more`
                };
            },

            normalizeQuantities(stockQty, stockUnit, neededQty, neededUnit) {
                // Normalize units to compare
                stockUnit = stockUnit.toLowerCase();
                neededUnit = neededUnit.toLowerCase();
                
                // Weight conversions
                const weightUnits = {
                    'g': 1,
                    'kg': 1000,
                    'grams': 1,
                    'kilograms': 1000
                };
                
                // Volume conversions
                const volumeUnits = {
                    'ml': 1,
                    'liters': 1000,
                    'litres': 1000,
                    'l': 1000,
                    'cups': 250,
                    'cup': 250
                };
                
                // Check if both are weight units
                if (weightUnits[stockUnit] && weightUnits[neededUnit]) {
                    return {
                        stockQuantity: stockQty * weightUnits[stockUnit],
                        neededQuantity: neededQty * weightUnits[neededUnit],
                        unit: 'g'
                    };
                }
                
                // Check if both are volume units
                if (volumeUnits[stockUnit] && volumeUnits[neededUnit]) {
                    return {
                        stockQuantity: stockQty * volumeUnits[stockUnit],
                        neededQuantity: neededQty * volumeUnits[neededUnit],
                        unit: 'ml'
                    };
                }
                
                // If units are exactly the same (like cans, boxes, etc)
                if (stockUnit === neededUnit) {
                    return {
                        stockQuantity: stockQty,
                        neededQuantity: neededQty,
                        unit: stockUnit
                    };
                }
                
                // Units don't match - can't compare
                return null;
            },

            generateConsolidatedShoppingList(projectId = null) {
                const consolidated = {};
                
                let projectsToProcess = projectId 
                    ? [this.recipeProjects.find(p => p.id === projectId)]
                    : this.recipeProjects.filter(p => !p.archived);
                
                projectsToProcess.forEach(project => {
                    if (!project) return;
                    project.recipes.forEach(recipe => {
                        recipe.ingredients.forEach(ing => {
                            if (ing.checked) return;
                            
                            const key = `${ing.name.toLowerCase()}-${ing.unit}`;
                            if (consolidated[key]) {
                                consolidated[key].quantity += ing.quantity;
                                consolidated[key].recipes.push(`${project.name}: ${recipe.name}`);
                                // Re-check inventory with updated quantity
                                const inventoryCheck = this.checkInventoryForIngredient(ing.name, ing.unit, consolidated[key].quantity);
                                consolidated[key].inStock = inventoryCheck ? inventoryCheck.enoughStock : false;
                                consolidated[key].inventoryCheck = inventoryCheck;
                            } else {
                                // Check if we have enough in inventory
                                const inventoryCheck = this.checkInventoryForIngredient(ing.name, ing.unit, ing.quantity);
                                
                                consolidated[key] = {
                                    name: ing.name,
                                    quantity: ing.quantity,
                                    unit: ing.unit,
                                    category: ing.category,
                                    recipes: [`${project.name}: ${recipe.name}`],
                                    inStock: inventoryCheck ? inventoryCheck.enoughStock : false,
                                    inventoryItem: inventoryCheck ? inventoryCheck.item : null,
                                    inventoryCheck: inventoryCheck
                                };
                            }
                        });
                    });
                });

                return Object.values(consolidated).sort((a, b) => {
                    // Sort by: not in stock first, then by category
                    if (a.inStock !== b.inStock) return a.inStock ? 1 : -1;
                    return a.category.localeCompare(b.category);
                });
            },

            downloadRecipeShoppingList(projectId = null) {
                const list = this.generateConsolidatedShoppingList(projectId);
                const rows = [['Item', 'Quantity', 'Unit', 'Category', 'In Stock?', 'Current Stock', 'For Recipes']];
                
                list.forEach(item => {
                    rows.push([
                        item.name,
                        item.quantity,
                        item.unit,
                        item.category,
                        item.inStock ? 'YES' : 'NO',
                        item.inventoryItem ? `${item.inventoryItem.quantity} ${item.inventoryItem.unit}` : 'N/A',
                        item.recipes.join('; ')
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-recipe-shopping-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Shopping list downloaded!');
            },

            printRecipeShoppingList(projectId = null) {
                const list = this.generateConsolidatedShoppingList(projectId);
                const projectName = projectId ? this.recipeProjects.find(p => p.id === projectId)?.name : 'All Active Projects';
                
                let printContent = `
                    <html>
                    <head>
                        <title>UTS Shopping List</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { color: #4f46e5; }
                            .category { margin-top: 20px; page-break-inside: avoid; }
                            .category-name { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #4f46e5; }
                            .item { margin-left: 20px; padding: 5px 0; display: flex; align-items: start; }
                            .checkbox { width: 20px; height: 20px; border: 2px solid #333; display: inline-block; margin-right: 10px; flex-shrink: 0; }
                            .in-stock { color: green; font-weight: bold; }
                            .need-buy { color: red; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <h1>🍳 Under the Stars - Shopping List</h1>
                        <h2>${projectName}</h2>
                        <p>Generated: ${new Date().toLocaleString()}</p>
                        <p>Total Items: ${list.length} | Need to Buy: ${list.filter(i => !i.inStock).length} | In Stock: ${list.filter(i => i.inStock).length}</p>
                        <hr>
                `;

                // Separate items into "Need to Buy" and "In Stock"
                const needToBuy = list.filter(i => !i.inStock);
                const inStock = list.filter(i => i.inStock);

                if (needToBuy.length > 0) {
                    printContent += '<h2 class="need-buy">🛒 NEED TO BUY</h2>';
                    const byCategory = {};
                    needToBuy.forEach(item => {
                        if (!byCategory[item.category]) byCategory[item.category] = [];
                        byCategory[item.category].push(item);
                    });

                    Object.keys(byCategory).sort().forEach(category => {
                        printContent += `<div class="category"><div class="category-name">${category}</div>`;
                        byCategory[category].forEach(item => {
                            printContent += `
                                <div class="item">
                                    <span class="checkbox"></span>
                                    <div>
                                        ${item.quantity} ${item.unit} ${item.name}
                                        <br><small style="color: #666;">${item.recipes.join('; ')}</small>
                                    </div>
                                </div>
                            `;
                        });
                        printContent += '</div>';
                    });
                }

                if (inStock.length > 0) {
                    printContent += '<h2 class="in-stock" style="margin-top: 30px;">✓ ALREADY IN STOCK</h2>';
                    inStock.forEach(item => {
                        printContent += `
                            <div class="item">
                                <span style="color: green; margin-right: 10px;">✓</span>
                                <div>
                                    ${item.quantity} ${item.unit} ${item.name}
                                    <small style="color: green;"> (Have: ${item.inventoryItem.quantity} ${item.inventoryItem.unit})</small>
                                    <br><small style="color: #666;">${item.recipes.join('; ')}</small>
                                </div>
                            </div>
                        `;
                    });
                }

                printContent += '</body></html>';

                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            },

            async save() {
                localStorage.setItem('uts-inventory', JSON.stringify(this.items));
            },

            toggleAddForm() {
                const formVisible = document.getElementById('addForm')?.classList.contains('hidden') === false;
                this.editingItemId = null;
                this.render(!formVisible);
                if (!formVisible) {
                    setTimeout(() => {
                        document.getElementById('addForm')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            },

            startEditItem(id) {
                this.editingItemId = id;
                this.render();
                setTimeout(() => {
                    document.getElementById(`edit-form-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            },

            cancelEdit() {
                this.editingItemId = null;
                this.render();
            },

            async addItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                // Check for duplicates
                const duplicate = this.items.find(i => i.name.toLowerCase() === name.toLowerCase());
                if (duplicate && !confirm(`"${name}" already exists in inventory. Add anyway?`)) {
                    return;
                }

                const item = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 0,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null,
                    lastupdated: new Date().toISOString()
                };

                if (useLocalStorage) {
                    item.id = Date.now();
                    this.items.push(item);
                    await this.save();
                    this.createBackup();
                    this.showNotification('✓ Item added!');
                    this.toggleAddForm();
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').insert([item]).select();
                        if (error) throw error;
                        await this.loadData();
                        this.showNotification('✓ Item added!');
                        this.toggleAddForm();
                    } catch (e) {
                        console.error('Full error:', e);
                        alert('Error saving item: ' + e.message);
                        return;
                    }
                }
            },

            async updateItem(id) {
                const name = document.getElementById(`editName-${id}`).value.trim();
                if (!name) return alert('Please enter item name');

                const updatedItem = {
                    name: name,
                    category: document.getElementById(`editCategory-${id}`).value,
                    quantity: parseInt(document.getElementById(`editQuantity-${id}`).value) || 0,
                    unit: document.getElementById(`editUnit-${id}`).value,
                    minstock: parseInt(document.getElementById(`editMinStock-${id}`).value) || 0,
                    expirydate: document.getElementById(`editExpiry-${id}`).value || null,
                    location: document.getElementById(`editLocation-${id}`).value.trim() || null,
                    notes: document.getElementById(`editNotes-${id}`).value.trim() || null,
                    lastupdated: new Date().toISOString()
                };

                if (useLocalStorage) {
                    const item = this.items.find(i => i.id === id);
                    if (item) {
                        Object.assign(item, updatedItem);
                        await this.save();
                        this.createBackup();
                    }
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update(updatedItem).eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating item: ' + e.message);
                        return;
                    }
                }

                this.showNotification('✓ Item updated!');
                this.editingItemId = null;
                this.render();
            },

            setFilter(filter) {
                if (this.filterStatus === filter) {
                    this.filterStatus = null; // Toggle off if clicking same filter
                } else {
                    this.filterStatus = filter;
                }
                this.selectedCategory = 'All'; // Reset category when filtering
                this.render();
            },

            clearFilters() {
                this.filterStatus = null;
                this.selectedCategory = 'All';
                this.render();
            },

            async updateQuantity(id, change) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;

                const oldQty = item.quantity;
                const newQty = Math.max(0, item.quantity + change);
                
                // Store undo action
                this.undoStack.push({
                    type: 'quantity',
                    itemId: id,
                    oldValue: oldQty,
                    newValue: newQty,
                    timestamp: Date.now()
                });
                if (this.undoStack.length > 10) this.undoStack.shift();

                this.recordUsage(id, item.name, change);

                if (useLocalStorage) {
                    item.quantity = newQty;
                    item.lastUpdated = new Date().toISOString();
                    await this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update({ 
                            quantity: newQty,
                            lastupdated: new Date().toISOString()
                        }).eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating quantity: ' + e.message);
                    }
                }
            },

            async deleteItem(id) {
                if (!confirm('Remove this item from inventory?')) return;

                if (useLocalStorage) {
                    this.items = this.items.filter(i => i.id !== id);
                    await this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').delete().eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error deleting item: ' + e.message);
                    }
                }
                this.showNotification('Item deleted');
            },

            getItemStatus(item) {
                if (item.quantity === 0 && (item.minstock || 0) > 0) return { color: 'bg-red-100 border-red-300', text: 'OUT OF STOCK' };
                if ((item.minstock || 0) > 0 && item.quantity <= item.minstock) return { color: 'bg-orange-100 border-orange-300', text: 'LOW STOCK' };
                
                if (item.expirydate) {
                    const days = Math.ceil((new Date(item.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (days < 0) return { color: 'bg-red-100 border-red-300', text: 'EXPIRED' };
                    if (days <= 7) return { color: 'bg-yellow-100 border-yellow-300', text: `EXPIRES IN ${days}D` };
                }
                
                return { color: 'bg-white border-gray-200', text: '' };
            },

            isRecentlyUpdated(item) {
                if (!item.lastUpdated) return false;
                const hoursSince = (new Date() - new Date(item.lastUpdated)) / (1000 * 60 * 60);
                return hoursSince < 24;
            },

            exportToCSV() {
                const rows = [['Name', 'Category', 'Quantity', 'Unit', 'Min Stock', 'Location', 'Expiry Date', 'Status', 'Notes']];
                
                this.items.forEach(item => {
                    const status = this.getItemStatus(item);
                    rows.push([
                        item.name,
                        item.category,
                        item.quantity,
                        item.unit,
                        item.minstock || 0,
                        item.location || '',
                        item.expirydate || '',
                        status.text,
                        item.notes || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported!');
            },

            generateShoppingList() {
                const needsRestock = this.items.filter(item => (item.minstock || 0) > 0 && item.quantity <= item.minstock);
                return needsRestock.sort((a, b) => a.category.localeCompare(b.category));
            },

            emailShoppingList() {
                const list = this.generateShoppingList();
                let body = 'UTS Inventory Shopping List\n\n';
                body += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                const byCategory = {};
                list.forEach(item => {
                    if (!byCategory[item.category]) byCategory[item.category] = [];
                    byCategory[item.category].push(item);
                });
                
                Object.keys(byCategory).sort().forEach(category => {
                    body += `${category}:\n`;
                    byCategory[category].forEach(item => {
                        body += `  • ${item.name} - Current: ${item.quantity} ${item.unit}, Need: ${item.minstock} ${item.unit}\n`;
                    });
                    body += '\n';
                });
                
                const mailto = `mailto:operations@underthestars.org.nz?subject=UTS Shopping List - ${new Date().toLocaleDateString()}&body=${encodeURIComponent(body)}`;
                window.location.href = mailto;
            },

            downloadShoppingList() {
                const list = this.generateShoppingList();
                const rows = [['Item', 'Category', 'Current Stock', 'Min Stock', 'Location']];
                
                list.forEach(item => {
                    rows.push([
                        item.name,
                        item.category,
                        `${item.quantity} ${item.unit}`,
                        `${item.minstock} ${item.unit}`,
                        item.location || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-shopping-list-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Shopping list downloaded!');
            },

            getConsumptionReport() {
                const last30Days = new Date();
                last30Days.setDate(last30Days.getDate() - 30);
                
                const recentUsage = this.usageHistory.filter(h => new Date(h.timestamp) >= last30Days);
                
                const byItem = {};
                recentUsage.forEach(usage => {
                    if (!byItem[usage.itemName]) {
                        byItem[usage.itemName] = { total: 0, count: 0 };
                    }
                    byItem[usage.itemName].total += usage.quantity;
                    byItem[usage.itemName].count++;
                });
                
                return Object.keys(byItem).map(itemName => ({
                    itemName,
                    totalUsed: byItem[itemName].total,
                    timesUsed: byItem[itemName].count,
                    avgPerUse: (byItem[itemName].total / byItem[itemName].count).toFixed(1)
                })).sort((a, b) => b.totalUsed - a.totalUsed);
            },

            addProjectFood() {
                const name = document.getElementById('projectFoodName').value.trim();
                const cost = parseFloat(document.getElementById('projectFoodCost').value);
                const date = document.getElementById('projectFoodDate').value;
                const project = document.getElementById('projectFoodProject').value.trim();
                
                if (!name || !cost || !date || !project) return alert('Please fill all fields');
                
                this.projectFoods.push({
                    id: Date.now(),
                    name: name,
                    cost: cost,
                    date: date,
                    project: project,
                    timestamp: new Date().toISOString()
                });
                
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Project food cost added!');
                
                document.getElementById('projectFoodName').value = '';
                document.getElementById('projectFoodCost').value = '';
                document.getElementById('projectFoodDate').value = '';
                document.getElementById('projectFoodProject').value = '';
                
                this.render();
            },

            deleteProjectFood(id) {
                if (!confirm('Delete this project food entry?')) return;
                this.projectFoods = this.projectFoods.filter(p => p.id !== id);
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Entry deleted');
                this.render();
            },

            loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.navigateTo('admin');
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

            logoutAdmin() {
                this.isAdmin = false;
                this.navigateTo('inventory');
            },

            downloadBackup() {
                const backup = {
                    items: this.items,
                    usageHistory: this.usageHistory,
                    projectFoods: this.projectFoods,
                    recipeProjects: this.recipeProjects,
                    categories: this.categories,
                    timestamp: new Date().toISOString(),
                    version: '3.0'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-complete-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Complete backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.items && this.validateData(backup.items)) {
                                this.items = backup.items;
                                this.usageHistory = backup.usageHistory || [];
                                this.projectFoods = backup.projectFoods || [];
                                this.recipeProjects = backup.recipeProjects || [];
                                if (backup.categories) this.categories = backup.categories;
                                this.save();
                                this.saveUsageHistory();
                                this.saveProjectFoods();
                                this.saveRecipeProjects();
                                this.saveCategories();
                                this.createBackup();
                                this.showNotification('Backup restored successfully!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            render(showAddForm = false) {
                const appEl = document.getElementById('app');
                
                if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else if (this.currentView === 'recipes') {
                    appEl.innerHTML = this.renderRecipes();
                } else {
                    appEl.innerHTML = this.renderInventory(showAddForm);
                }
            },

            renderRecipes() {
                const activeProjects = this.recipeProjects.filter(p => !p.archived);
                const archivedProjects = this.recipeProjects.filter(p => p.archived);
                
                const projectsToShow = this.recipeView === 'archived' ? archivedProjects : activeProjects;
                const selectedProject = this.selectedProjectId ? this.recipeProjects.find(p => p.id === this.selectedProjectId) : null;
                const shoppingList = this.generateConsolidatedShoppingList(this.selectedProjectId);
                
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-6xl mx-auto">
                            ${!useLocalStorage ? '<div class="bg-blue-100 text-blue-800 p-2 rounded-lg mb-4 text-xs text-center font-semibold">✓ Supabase Connected - Inventory & Recipes Syncing Across Devices</div>' : '<div class="bg-yellow-100 text-yellow-800 p-2 rounded-lg mb-4 text-xs text-center font-semibold">⚠ Local Storage Mode - No Cross-Device Sync</div>'}
                            
                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-800">🍳 Recipe & Bulk Cook Planner</h1>
                                        <p class="text-sm text-gray-600">Organize recipes by project • Check inventory • Generate shopping lists</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="app.navigateTo('inventory');" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 text-sm">
                                            ← Inventory
                                        </button>
                                        ${this.isAdmin ? '<button onclick="app.navigateTo(\'admin\');" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">Admin</button>' : ''}
                                    </div>
                                </div>

                                <div class="flex gap-2 mb-4">
                                    <button
                                        onclick="app.navigateTo('recipes', 'active');"
                                        class="flex-1 px-4 py-2 rounded-lg font-semibold ${
                                            this.recipeView === 'active'
                                                ? 'bg-indigo-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }">
                                        📁 Active Projects (${activeProjects.length})
                                    </button>
                                    <button
                                        onclick="app.navigateTo('recipes', 'archived');"
                                        class="flex-1 px-4 py-2 rounded-lg font-semibold ${
                                            this.recipeView === 'archived'
                                                ? 'bg-indigo-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }">
                                        📦 Archived (${archivedProjects.length})
                                    </button>
                                    <button
                                        onclick="app.navigateTo('recipes', 'shopping');"
                                        class="flex-1 px-4 py-2 rounded-lg font-semibold ${
                                            this.recipeView === 'shopping'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-100 text-gray-700'
                                        }">
                                        🛒 Shopping (${shoppingList.length})
                                    </button>
                                </div>

                                ${this.recipeView !== 'shopping' ? `
                                    <button onclick="app.createNewProject()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-700">
                                        + Create New Project
                                    </button>
                                ` : ''}
                            </div>

                            ${this.recipeView === 'shopping' ? `
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <div class="flex justify-between items-center mb-6">
                                        <div>
                                            <h2 class="text-xl font-bold">🛒 Shopping List</h2>
                                            <p class="text-sm text-gray-600">
                                                ${this.selectedProjectId ? selectedProject?.name : 'All Active Projects'}
                                            </p>
                                        </div>
                                        <div class="flex gap-2">
                                            ${this.selectedProjectId ? `
                                                <button
                                                    onclick="app.navigateTo('recipes', 'shopping', null);"
                                                    class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm"
                                                >
                                                    Show All
                                                </button>
                                            ` : ''}
                                            <button
                                                onclick="app.printRecipeShoppingList(${this.selectedProjectId || 'null'})"
                                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm"
                                            >
                                                🖨️ Print
                                            </button>
                                            <button
                                                onclick="app.downloadRecipeShoppingList(${this.selectedProjectId || 'null'})"
                                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm"
                                            >
                                                📥 CSV
                                            </button>
                                        </div>
                                    </div>

                                    ${shoppingList.length === 0 ? `
                                        <p class="text-gray-500 text-center py-8">
                                            No items needed! All ingredients are checked off or no active projects.
                                        </p>
                                    ` : `
                                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                            <div class="grid grid-cols-3 gap-4 text-center">
                                                <div>
                                                    <div class="text-2xl font-bold text-red-600">${shoppingList.filter(i => !i.inStock).length}</div>
                                                    <div class="text-xs text-gray-600">Need to Buy</div>
                                                </div>
                                                <div>
                                                    <div class="text-2xl font-bold text-green-600">${shoppingList.filter(i => i.inStock).length}</div>
                                                    <div class="text-xs text-gray-600">In Stock</div>
                                                </div>
                                                <div>
                                                    <div class="text-2xl font-bold text-blue-600">${shoppingList.length}</div>
                                                    <div class="text-xs text-gray-600">Total Items</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="space-y-6">
                                            ${Object.entries(
                                                shoppingList.reduce((acc, item) => {
                                                    if (!acc[item.category]) acc[item.category] = [];
                                                    acc[item.category].push(item);
                                                    return acc;
                                                }, {})
                                            ).map(([category, items]) => `
                                                <div>
                                                    <h3 class="font-bold text-lg mb-3 text-indigo-600">${category}</h3>
                                                    <div class="space-y-2">
                                                        ${items.map(item => `
                                                            <div class="flex items-start gap-3 p-3 ${item.inStock ? 'bg-green-50' : 'bg-orange-50'} rounded-lg">
                                                                <div class="flex-1">
                                                                    <div class="flex items-center gap-2 mb-1">
                                                                        <span class="font-semibold">
                                                                            ${item.quantity} ${item.unit} ${item.name}
                                                                        </span>
                                                                        ${item.inStock && item.inventoryCheck ? `
                                                                            <span class="text-xs px-2 py-1 bg-green-200 text-green-800 rounded-full font-semibold">
                                                                                ✓ ${item.inventoryCheck.message}
                                                                            </span>
                                                                        ` : item.inventoryCheck && item.inventoryCheck.inStock && !item.inventoryCheck.enoughStock ? `
                                                                            <span class="text-xs px-2 py-1 bg-orange-200 text-orange-800 rounded-full font-semibold">
                                                                                ⚠ ${item.inventoryCheck.message}
                                                                            </span>
                                                                        ` : `
                                                                            <span class="text-xs px-2 py-1 bg-red-200 text-red-800 rounded-full font-semibold">
                                                                                ⚠ NEED TO BUY ${item.quantity} ${item.unit}
                                                                            </span>
                                                                        `}
                                                                    </div>
                                                                    <div class="text-xs text-gray-600">
                                                                        For: ${item.recipes.join(' • ')}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            ` : `
                                ${projectsToShow.length === 0 ? `
                                    <div class="bg-white rounded-lg shadow-md p-12 text-center">
                                        <p class="text-gray-500 mb-4">
                                            ${this.recipeView === 'archived' ? 'No archived projects yet.' : 'No projects yet. Create one to get started!'}
                                        </p>
                                    </div>
                                ` : projectsToShow.map(project => `
                                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex-1">
                                                <h3 class="text-xl font-bold text-gray-800">${project.name}</h3>
                                                <p class="text-sm text-gray-600">
                                                    ${project.recipes.length} recipes • Created ${new Date(project.createdAt).toLocaleDateString()}
                                                    ${project.archived ? ' • <span class="text-orange-600 font-semibold">ARCHIVED</span>' : ''}
                                                </p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button
                                                    onclick="app.navigateTo('recipes', 'shopping', ${project.id});"
                                                    class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm"
                                                >
                                                    🛒 Shopping
                                                </button>
                                                <button
                                                    onclick="app.archiveProject(${project.id})"
                                                    class="bg-orange-500 text-white px-3 py-2 rounded-lg hover:bg-orange-600 text-sm"
                                                >
                                                    ${project.archived ? '📂 Unarchive' : '📦 Archive'}
                                                </button>
                                                <button
                                                    onclick="app.deleteProject(${project.id})"
                                                    class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm"
                                                >
                                                    🗑️
                                                </button>
                                            </div>
                                        </div>

                                        ${!project.archived ? `
                                            <div class="mb-4 border-t pt-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4">
                                                <h4 class="font-semibold mb-3 text-lg">➕ Add Recipe</h4>
                                                
                                                <div class="grid md:grid-cols-2 gap-3">
                                                    <!-- Quick Manual Entry -->
                                                    <div class="bg-white rounded-lg p-4 border-2 border-green-500">
                                                        <div class="text-sm font-bold text-green-700 mb-2">✏️ MANUAL ENTRY</div>
                                                        <p class="text-xs text-gray-600 mb-3">Create recipe, then add ingredients one by one</p>
                                                        <button onclick="app.addManualRecipe(${project.id})" 
                                                            class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 font-bold">
                                                            + New Recipe
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- Auto Parse -->
                                                    <div class="bg-white rounded-lg p-4 border-2 border-blue-500">
                                                        <div class="text-sm font-bold text-blue-700 mb-2">🤖 AUTO-PARSE</div>
                                                        <p class="text-xs text-gray-600 mb-3">Paste recipe text, extract ingredients automatically</p>
                                                        <button onclick="document.getElementById('autoparse-${project.id}').classList.toggle('hidden')" 
                                                            class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-bold">
                                                            Paste Recipe
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Auto-parse form (collapsible) -->
                                                <div id="autoparse-${project.id}" class="hidden mt-3 bg-white rounded-lg p-4 border-2 border-blue-300">
                                                    <div class="mb-2">
                                                        <label class="text-sm font-semibold text-gray-700">Recipe Name:</label>
                                                        <input
                                                            type="text"
                                                            id="recipeName-${project.id}"
                                                            placeholder="e.g., Spaghetti Bolognese"
                                                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm mt-1"
                                                        />
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="text-sm font-semibold text-gray-700">Servings:</label>
                                                        <input
                                                            type="number"
                                                            id="recipeServings-${project.id}"
                                                            value="50"
                                                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm mt-1"
                                                            min="1"
                                                        />
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="text-sm font-semibold text-gray-700">Paste Ingredients (one per line):</label>
                                                        <div class="bg-blue-50 p-2 rounded text-xs text-blue-800 mb-2">
                                                            <strong>✓ Works with ANY of these formats:</strong><br>
                                                            • 2kg beef mince<br>
                                                            • 500 grams flour<br>
                                                            • 3 cans tomatoes<br>
                                                            • 2 cups milk<br>
                                                            • beef - 2kg<br>
                                                            • 1.5 liters water
                                                        </div>
                                                        <textarea
                                                            id="recipeInput-${project.id}"
                                                            placeholder="2kg beef mince
1kg spaghetti  
3 cans tomatoes
2 onions
500g mushrooms
4 cloves garlic"
                                                            class="w-full h-40 border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono"
                                                        ></textarea>
                                                    </div>
                                                    <button
                                                        onclick="app.parseRecipe(${project.id})"
                                                        class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-bold"
                                                    >
                                                        🤖 Extract & Add to Project
                                                    </button>
                                                    <button
                                                        onclick="app.previewParsing(${project.id})"
                                                        class="w-full bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 font-bold mt-2"
                                                    >
                                                        👀 Preview What Will Be Extracted (Test)
                                                    </button>
                                                </div>
                                            </div>
                                        ` : ''}

                                        <div class="space-y-4">
                                            ${project.recipes.length === 0 ? `
                                                <p class="text-gray-500 text-center py-4 text-sm">No recipes in this project yet.</p>
                                            ` : project.recipes.map(recipe => `
                                                <div class="border-t pt-4">
                                                    <div class="flex justify-between items-start mb-3">
                                                        <div class="flex-1">
                                                            <h4 class="font-bold text-gray-800 text-lg">${recipe.name}</h4>
                                                            <div class="flex items-center gap-3 mt-1 flex-wrap">
                                                                <span class="text-sm text-gray-600">${recipe.servings} servings • ${recipe.ingredients.length} ingredients</span>
                                                                ${!project.archived && recipe.ingredients.length > 0 ? `
                                                                    <button
                                                                        onclick="app.scaleRecipe(${project.id}, ${recipe.id})"
                                                                        class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-700 font-bold"
                                                                        title="Change number of servings - all quantities will auto-calculate"
                                                                    >
                                                                        📐 Scale to Different Servings
                                                                    </button>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            ${!project.archived ? `
                                                                <button
                                                                    onclick="app.addIngredientToRecipe(${project.id}, ${recipe.id})"
                                                                    class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 font-semibold"
                                                                >
                                                                    + Ingredient
                                                                </button>
                                                            ` : ''}
                                                            <button
                                                                onclick="app.deleteRecipe(${project.id}, ${recipe.id})"
                                                                class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600 font-semibold"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="space-y-1">
                                                        ${recipe.ingredients.length === 0 ? `
                                                            <p class="text-gray-500 text-sm italic py-2">No ingredients yet. Click "+ Ingredient" to add.</p>
                                                        ` : recipe.ingredients.map((ing, idx) => {
                                                            const inventoryCheck = app.checkInventoryForIngredient(ing.name, ing.unit, ing.quantity);
                                                            return `
                                                                <div class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded ${ing.checked ? 'opacity-50' : ''}">
                                                                    <input
                                                                        type="checkbox"
                                                                        ${ing.checked ? 'checked' : ''}
                                                                        onchange="app.toggleRecipeIngredient(${project.id}, ${recipe.id}, ${idx})"
                                                                        class="w-4 h-4 cursor-pointer"
                                                                    />
                                                                    <span class="flex-1 text-sm ${ing.checked ? 'line-through text-gray-400' : ''}">
                                                                        ${ing.quantity} ${ing.unit} ${ing.name}
                                                                    </span>
                                                                    ${inventoryCheck && inventoryCheck.enoughStock ? `
                                                                        <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-semibold">
                                                                            ✓ ${inventoryCheck.message}
                                                                        </span>
                                                                    ` : inventoryCheck && inventoryCheck.inStock && !inventoryCheck.enoughStock ? `
                                                                        <span class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded-full font-semibold" title="${inventoryCheck.message}">
                                                                            ⚠ Need ${inventoryCheck.shortage.toFixed(1)} ${inventoryCheck.unit} more
                                                                        </span>
                                                                    ` : `
                                                                        <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded-full font-semibold">
                                                                            ⚠ Need to buy
                                                                        </span>
                                                                    `}
                                                                    <span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">${ing.category}</span>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>

                                                    <details class="mt-2">
                                                        <summary class="cursor-pointer text-xs text-indigo-600 hover:text-indigo-800">
                                                            View Original Recipe
                                                        </summary>
                                                        <pre class="mt-2 text-xs bg-gray-50 p-3 rounded overflow-x-auto whitespace-pre-wrap">${recipe.originalText}</pre>
                                                    </details>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                `;
            },

            renderAdmin() {
                const shoppingList = this.generateShoppingList();
                const consumption = this.getConsumptionReport();
                
                const projectTotals = {};
                this.projectFoods.forEach(p => {
                    if (!projectTotals[p.project]) {
                        projectTotals[p.project] = 0;
                    }
                    projectTotals[p.project] += p.cost;
                });
                const totalProjectCosts = this.projectFoods.reduce((sum, p) => sum + p.cost, 0);
                
                const stats = {
                    total: this.items.length,
                    lowStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity <= i.minstock && i.quantity > 0).length,
                    outOfStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity === 0).length,
                    expiringSoon: this.items.filter(i => {
                        if (!i.expirydate) return false;
                        const days = Math.ceil((new Date(i.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days >= 0 && days <= 7;
                    }).length
                };

                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-7xl mx-auto">
                            ${!useLocalStorage ? '<div class="bg-blue-100 text-blue-800 p-3 rounded mb-4 text-sm text-center font-semibold">✓ Supabase Connected</div>' : '<div class="bg-yellow-100 text-yellow-800 p-3 rounded mb-4 text-sm text-center font-semibold">⚠ Local Storage Mode</div>'}
                            
                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                                    <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                                    <div class="flex gap-2 flex-wrap">
                                        <button onclick="app.navigateTo('inventory');" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Inventory</button>
                                        <button onclick="app.navigateTo('recipes');" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Recipes</button>
                                        <button onclick="app.logoutAdmin()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Logout</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
                                        <div class="text-xs text-gray-600">Total Items</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-orange-600">${stats.lowStock}</div>
                                        <div class="text-xs text-gray-600">Low Stock</div>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-red-600">${stats.outOfStock}</div>
                                        <div class="text-xs text-gray-600">Out of Stock</div>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-yellow-600">${stats.expiringSoon}</div>
                                        <div class="text-xs text-gray-600">Expiring Soon</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <button onclick="app.exportToCSV()" class="bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 text-sm">
                                        📊 Export Inventory
                                    </button>
                                    <button onclick="app.downloadBackup()" class="bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 text-sm">
                                        💾 Download Backup
                                    </button>
                                    <button onclick="app.uploadBackup()" class="bg-orange-600 text-white p-3 rounded-lg font-bold hover:bg-orange-700 text-sm">
                                        📤 Restore Backup
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold">Categories</h2>
                                    <button onclick="app.addCategory()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                                        + Add
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${this.categories.filter(c => c !== 'All').map(cat => `
                                        <div class="flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-lg">
                                            <span class="text-sm">${cat}</span>
                                            <button onclick="app.deleteCategory('${cat}')" class="text-red-600 hover:text-red-800 font-bold">×</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                                    <h2 class="text-xl font-bold">Inventory Shopping List (${shoppingList.length})</h2>
                                    <div class="flex gap-2">
                                        <button onclick="app.downloadShoppingList()" class="bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                                            📥 CSV
                                        </button>
                                        <button onclick="app.emailShoppingList()" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                            📧 Email
                                        </button>
                                    </div>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    ${shoppingList.length === 0 ? '<p class="text-gray-500 text-center py-8 text-sm">All stocked! 🎉</p>' : `
                                        <div class="space-y-2">
                                            ${shoppingList.map(item => `
                                                <div class="border-b pb-2">
                                                    <div class="font-semibold text-sm">${item.name}</div>
                                                    <div class="text-xs text-gray-600">${item.category} • Current: ${item.quantity} ${item.unit} • Need: ${item.minstock} ${item.unit}</div>
                                                    ${item.lastUpdated ? `<div class="text-xs text-gray-400">Updated: ${new Date(item.lastUpdated).toLocaleString()}</div>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4">Recent Changes</h2>
                                <div class="max-h-96 overflow-y-auto">
                                    ${(() => {
                                        const recentChanges = this.items
                                            .filter(i => i.lastUpdated)
                                            .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))
                                            .slice(0, 20);
                                        
                                        return recentChanges.length === 0 ? '<p class="text-gray-500 text-center py-8 text-sm">No recent changes tracked</p>' : `
                                            <div class="space-y-2">
                                                ${recentChanges.map(item => {
                                                    const timeAgo = Math.floor((new Date() - new Date(item.lastUpdated)) / (1000 * 60));
                                                    const timeStr = timeAgo < 60 ? `${timeAgo}m ago` : 
                                                                   timeAgo < 1440 ? `${Math.floor(timeAgo / 60)}h ago` : 
                                                                   `${Math.floor(timeAgo / 1440)}d ago`;
                                                    return `
                                                        <div class="border-b pb-2">
                                                            <div class="font-semibold text-sm">${item.name}</div>
                                                            <div class="text-xs text-gray-600">${item.category} • ${item.quantity} ${item.unit}</div>
                                                            <div class="text-xs text-blue-600">${timeStr} - ${new Date(item.lastUpdated).toLocaleString()}</div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        `;
                                    })()}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4">Consumption (30 Days)</h2>
                                <div class="max-h-96 overflow-y-auto">
                                    ${consumption.length === 0 ? '<p class="text-gray-500 text-center py-8 text-sm">No usage data yet</p>' : `
                                        <div class="space-y-2">
                                            ${consumption.slice(0, 10).map(item => `
                                                <div class="border-b pb-2">
                                                    <div class="font-semibold text-sm">${item.itemName}</div>
                                                    <div class="text-xs text-gray-600">Used: ${item.totalUsed} • Times: ${item.timesUsed} • Avg: ${item.avgPerUse}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-xl font-bold mb-4">Project Food Costs</h2>
                                <div class="bg-green-50 p-4 rounded-lg mb-4">
                                    <div class="text-2xl font-bold text-green-600">$${totalProjectCosts.toFixed(2)}</div>
                                    <div class="text-xs text-gray-600">Total Project Costs</div>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-3 mb-4">
                                    <input type="text" id="projectFoodName" placeholder="Item name" class="border rounded-lg px-4 py-2 text-sm">
                                    <input type="number" id="projectFoodCost" placeholder="Cost ($)" step="0.01" class="border rounded-lg px-4 py-2 text-sm">
                                    <input type="date" id="projectFoodDate" class="border rounded-lg px-4 py-2 text-sm">
                                    <input type="text" id="projectFoodProject" placeholder="Project name" class="border rounded-lg px-4 py-2 text-sm">
                                </div>
                                <button onclick="app.addProjectFood()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 w-full text-sm">
                                    Add Cost Entry
                                </button>

                                <div class="max-h-96 overflow-y-auto mt-4">
                                    ${this.projectFoods.length === 0 ? '<p class="text-gray-500 text-center py-8 text-sm">No costs recorded</p>' : `
                                        <div class="space-y-2">
                                            ${this.projectFoods.sort((a, b) => new Date(b.date) - new Date(a.date)).map(item => `
                                                <div class="border-b pb-2 flex justify-between items-start">
                                                    <div>
                                                        <div class="font-semibold text-sm">${item.name}</div>
                                                        <div class="text-xs text-gray-600">${item.project} • ${new Date(item.date).toLocaleDateString()}</div>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-green-600 font-bold text-sm">$${item.cost.toFixed(2)}</span>
                                                        <button onclick="app.deleteProjectFood(${item.id})" class="text-red-600 hover:text-red-800 text-xs">Delete</button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderInventory(showAddForm) {
                const searchTerm = document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
                
                let filtered = this.items.filter(item => {
                    const matchesSearch = item.name.toLowerCase().includes(searchTerm) || 
                                         (item.notes && item.notes.toLowerCase().includes(searchTerm)) ||
                                         (item.location && item.location.toLowerCase().includes(searchTerm));
                    const matchesCategory = this.selectedCategory === 'All' || item.category === this.selectedCategory;
                    
                    // Apply status filter
                    let matchesStatus = true;
                    if (this.filterStatus === 'low') {
                        matchesStatus = (item.minstock || 0) > 0 && item.quantity <= item.minstock && item.quantity > 0;
                    } else if (this.filterStatus === 'out') {
                        matchesStatus = (item.minstock || 0) > 0 && item.quantity === 0;
                    } else if (this.filterStatus === 'expiring') {
                        if (item.expirydate) {
                            const days = Math.ceil((new Date(item.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                            matchesStatus = days >= 0 && days <= 7;
                        } else {
                            matchesStatus = false;
                        }
                    }
                    
                    return matchesSearch && matchesCategory && matchesStatus;
                }).sort((a, b) => a.name.localeCompare(b.name));

                const stats = {
                    total: this.items.length,
                    lowStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity <= i.minstock && i.quantity > 0).length,
                    outOfStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity === 0).length,
                    expiringSoon: this.items.filter(i => {
                        if (!i.expirydate) return false;
                        const days = Math.ceil((new Date(i.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days >= 0 && days <= 7;
                    }).length
                };

                return `
                    <div class="min-h-screen p-4 pb-20">
                        <div class="max-w-6xl mx-auto">
                            ${!useLocalStorage ? '<div class="bg-blue-100 text-blue-800 p-2 rounded-lg mb-4 text-xs text-center font-semibold">✓ Supabase Connected - Syncing Across Devices</div>' : '<div class="bg-yellow-100 text-yellow-800 p-2 rounded-lg mb-4 text-xs text-center font-semibold">⚠ Local Storage Mode - No Cross-Device Sync</div>'}
                            
                            <div class="bg-white rounded-lg shadow-md p-4 mb-4">
                                <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
                                    <h1 class="text-2xl font-bold text-gray-800">🍽️ UTS Inventory</h1>
                                    <div class="flex gap-2 flex-wrap">
                                        <button onclick="app.navigateTo('recipes');" class="bg-green-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-green-700 text-xs">🍳 Recipes</button>
                                        ${this.isAdmin ? '<button onclick="app.navigateTo(\'admin\');" class="bg-purple-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-purple-700 text-xs">Admin</button>' : ''}
                                        ${!this.isAdmin ? '<button onclick="app.loginAdmin()" class="text-gray-400 hover:text-gray-600 text-xs px-2 py-1">Admin</button>' : ''}
                                        <button onclick="app.exportToCSV()" class="bg-gray-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-gray-700 text-xs">📊 Export</button>
                                        <button onclick="app.toggleAddForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 text-sm">+ Add Item</button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                    <button onclick="app.clearFilters()" class="bg-blue-50 p-3 rounded-lg hover:bg-blue-100 transition text-left">
                                        <div class="text-xl font-bold text-blue-600">${stats.total}</div>
                                        <div class="text-xs text-gray-600">Total Items</div>
                                    </button>
                                    <button onclick="app.setFilter('low')" class="bg-orange-50 p-3 rounded-lg hover:bg-orange-100 transition text-left ${this.filterStatus === 'low' ? 'ring-2 ring-orange-500' : ''}">
                                        <div class="text-xl font-bold text-orange-600">${stats.lowStock}</div>
                                        <div class="text-xs text-gray-600">Low Stock ${this.filterStatus === 'low' ? '✓' : '(click)'}</div>
                                    </button>
                                    <button onclick="app.setFilter('out')" class="bg-red-50 p-3 rounded-lg hover:bg-red-100 transition text-left ${this.filterStatus === 'out' ? 'ring-2 ring-red-500' : ''}">
                                        <div class="text-xl font-bold text-red-600">${stats.outOfStock}</div>
                                        <div class="text-xs text-gray-600">Out of Stock ${this.filterStatus === 'out' ? '✓' : '(click)'}</div>
                                    </button>
                                    <button onclick="app.setFilter('expiring')" class="bg-yellow-50 p-3 rounded-lg hover:bg-yellow-100 transition text-left ${this.filterStatus === 'expiring' ? 'ring-2 ring-yellow-500' : ''}">
                                        <div class="text-xl font-bold text-yellow-600">${stats.expiringSoon}</div>
                                        <div class="text-xs text-gray-600">Expiring Soon ${this.filterStatus === 'expiring' ? '✓' : '(click)'}</div>
                                    </button>
                                </div>
                                
                                ${this.filterStatus ? `
                                    <div class="bg-indigo-50 border-l-4 border-indigo-500 p-3 mb-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-semibold text-indigo-700">
                                                Showing: ${
                                                    this.filterStatus === 'low' ? 'Low Stock Items' :
                                                    this.filterStatus === 'out' ? 'Out of Stock Items' :
                                                    'Expiring Soon'
                                                } (${filtered.length})
                                            </span>
                                            <button onclick="app.clearFilters()" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-700">
                                                Clear Filter
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <div id="addForm" class="bg-white rounded-lg shadow-md p-4 mb-4 ${showAddForm ? '' : 'hidden'}">
                                <h2 class="text-lg font-bold mb-3">➕ Add New Item</h2>
                                <div class="grid grid-cols-1 gap-3 mb-3">
                                    <input type="text" id="itemName" placeholder="Item name *" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <select id="itemCategory" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        ${this.categories.filter(c => c !== 'All').map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                    </select>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="itemQuantity" placeholder="Quantity" value="0" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <select id="itemUnit" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="units">units</option>
                                            <option value="kg">kg</option>
                                            <option value="g">g</option>
                                            <option value="liters">liters</option>
                                            <option value="boxes">boxes</option>
                                            <option value="bags">bags</option>
                                            <option value="cans">cans</option>
                                            <option value="packets">packets</option>
                                            <option value="bottles">bottles</option>
                                        </select>
                                    </div>
                                    <input type="number" id="itemMinStock" placeholder="Min stock (0 = no alert)" value="0" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <input type="date" id="itemExpiry" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <input type="text" id="itemLocation" placeholder="Location (e.g., Pantry Shelf 2)" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <textarea id="itemNotes" placeholder="Notes" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
                                </div>
                                <button onclick="app.addItem()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700">
                                    ✓ Add Item
                                </button>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-4 mb-4 sticky top-0 z-10">
                                <div class="mb-3">
                                    <input type="text" id="searchInput" placeholder="🔍 Search items, notes, or location..." oninput="app.render()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div class="flex gap-2 overflow-x-auto pb-2">
                                    ${this.categories.map(cat => `
                                        <button onclick="app.selectedCategory='${cat}'; app.render()" 
                                            class="px-3 py-1 rounded-lg text-sm font-medium whitespace-nowrap ${
                                                this.selectedCategory === cat
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-gray-100 text-gray-700'
                                            }">
                                            ${cat}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="space-y-3">
                                ${filtered.length === 0 ? `
                                    <div class="bg-white rounded-lg shadow-md p-12 text-center">
                                        <p class="text-gray-500">
                                            ${this.items.length === 0 ? 'No items yet. Click "+ Add Item"!' : 'No matches found. Try a different search.'}
                                        </p>
                                    </div>
                                ` : filtered.map(item => {
                                    const status = this.getItemStatus(item);
                                    const isRecent = this.isRecentlyUpdated(item);
                                    const isEditing = this.editingItemId === item.id;
                                    
                                    if (isEditing) {
                                        return `
                                            <div id="edit-form-${item.id}" class="bg-blue-50 border-2 border-blue-400 rounded-lg p-4 fade-in">
                                                <h3 class="text-lg font-bold mb-3">✏️ Editing: ${item.name}</h3>
                                                <div class="grid grid-cols-1 gap-3 mb-3">
                                                    <input type="text" id="editName-${item.id}" value="${item.name}" class="border rounded-lg px-3 py-2">
                                                    <select id="editCategory-${item.id}" class="border rounded-lg px-3 py-2">
                                                        ${this.categories.filter(c => c !== 'All').map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                                    </select>
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <input type="number" id="editQuantity-${item.id}" value="${item.quantity}" class="border rounded-lg px-3 py-2">
                                                        <select id="editUnit-${item.id}" class="border rounded-lg px-3 py-2">
                                                            <option value="units" ${item.unit === 'units' ? 'selected' : ''}>units</option>
                                                            <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option>
                                                            <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option>
                                                            <option value="liters" ${item.unit === 'liters' ? 'selected' : ''}>liters</option>
                                                            <option value="boxes" ${item.unit === 'boxes' ? 'selected' : ''}>boxes</option>
                                                            <option value="bags" ${item.unit === 'bags' ? 'selected' : ''}>bags</option>
                                                            <option value="cans" ${item.unit === 'cans' ? 'selected' : ''}>cans</option>
                                                            <option value="packets" ${item.unit === 'packets' ? 'selected' : ''}>packets</option>
                                                            <option value="bottles" ${item.unit === 'bottles' ? 'selected' : ''}>bottles</option>
                                                        </select>
                                                    </div>
                                                    <input type="number" id="editMinStock-${item.id}" value="${item.minstock || 0}" placeholder="Min stock" class="border rounded-lg px-3 py-2">
                                                    <input type="date" id="editExpiry-${item.id}" value="${item.expirydate || ''}" class="border rounded-lg px-3 py-2">
                                                    <input type="text" id="editLocation-${item.id}" value="${item.location || ''}" placeholder="Location" class="border rounded-lg px-3 py-2">
                                                    <textarea id="editNotes-${item.id}" placeholder="Notes" class="border rounded-lg px-3 py-2" rows="2">${item.notes || ''}</textarea>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="app.updateItem(${item.id})" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700">
                                                        ✓ Save Changes
                                                    </button>
                                                    <button onclick="app.cancelEdit()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-600">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    return `
                                        <div class="${status.color} border-2 rounded-lg p-3 fade-in">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                        <h3 class="text-lg font-bold text-gray-800">${item.name}</h3>
                                                        ${isRecent ? '<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full font-semibold">UPDATED</span>' : ''}
                                                        <span class="text-xs px-2 py-0.5 bg-gray-200 rounded-full text-gray-600">${item.category}</span>
                                                        ${item.location ? `<span class="text-xs px-2 py-0.5 bg-blue-100 rounded-full text-blue-700">📍 ${item.location}</span>` : ''}
                                                    </div>
                                                    <div class="text-base font-bold ${item.quantity === 0 && (item.minstock || 0) > 0 ? 'text-red-600' : 'text-gray-800'}">
                                                        ${item.quantity} ${item.unit}
                                                    </div>
                                                    ${item.expirydate ? `<div class="text-xs text-gray-600">Expires: ${new Date(item.expirydate).toLocaleDateString()}</div>` : ''}
                                                    ${item.notes ? `<div class="text-xs text-gray-600 italic mt-1">📝 ${item.notes}</div>` : ''}
                                                    ${status.text ? `
                                                        <div class="inline-flex items-center gap-1 mt-1 bg-orange-50 px-2 py-1 rounded text-xs font-bold text-orange-700">
                                                            ⚠ ${status.text}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            
                                            <div class="flex gap-2 mb-3">
                                                <button onclick="app.startEditItem(${item.id})" class="flex-1 bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 font-semibold text-sm">
                                                    ✏️ Edit Details
                                                </button>
                                                <button onclick="app.deleteItem(${item.id})" class="bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600 font-semibold text-sm">
                                                    🗑️
                                                </button>
                                            </div>
                                            
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <div class="text-xs font-semibold text-gray-600 mb-2">QUICK ADJUST:</div>
                                                <div class="grid grid-cols-3 gap-2 mb-2">
                                                    <button onclick="app.updateQuantity(${item.id}, -10)" class="bg-red-600 text-white px-3 py-4 rounded-lg hover:bg-red-700 font-bold text-lg">-10</button>
                                                    <button onclick="app.updateQuantity(${item.id}, -5)" class="bg-red-500 text-white px-3 py-4 rounded-lg hover:bg-red-600 font-bold text-lg">-5</button>
                                                    <button onclick="app.updateQuantity(${item.id}, -1)" class="bg-red-400 text-white px-3 py-4 rounded-lg hover:bg-red-500 font-bold text-lg">-1</button>
                                                </div>
                                                <div class="grid grid-cols-3 gap-2">
                                                    <button onclick="app.updateQuantity(${item.id}, 1)" class="bg-green-400 text-white px-3 py-4 rounded-lg hover:bg-green-500 font-bold text-lg">+1</button>
                                                    <button onclick="app.updateQuantity(${item.id}, 5)" class="bg-green-500 text-white px-3 py-4 rounded-lg hover:bg-green-600 font-bold text-lg">+5</button>
                                                    <button onclick="app.updateQuantity(${item.id}, 10)" class="bg-green-600 text-white px-3 py-4 rounded-lg hover:bg-green-700 font-bold text-lg">+10</button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
