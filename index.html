<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTS Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .quantity-dropdown {
            display: none;
        }
        .quantity-dropdown.active {
            display: grid;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://slelvrwtokiqlhletpsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZWx2cnd0b2tpcWxobGV0cHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODM3MTEsImV4cCI6MjA3NzM1OTcxMX0.mvO2vGyMlvmeV0tn60RL9dbzKkScBfXcFqMY-rTBmHM';
        const ADMIN_PASSWORD = 'UTS2025Admin';
        
        let supabase = null;
        let useLocalStorage = true;

        if (SUPABASE_URL && SUPABASE_KEY) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                useLocalStorage = false;
                console.log('Supabase connected successfully');
            } catch (e) {
                console.log('Supabase connection failed, using local storage:', e);
                useLocalStorage = true;
            }
        }

        function toggleQuantityDropdown(id) {
            const dropdown = document.getElementById(`qty-${id}`);
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        const app = {
            items: [],
            usageHistory: [],
            projectFoods: [],
            selectedCategory: 'All',
            currentView: 'inventory',
            isAdmin: false,
            backupCount: 10,
            editingItemId: null,
            compactView: false,
            categories: ['All', 'Pasta/Grain', 'Canned Goods', 'Disposables', 'Equipment', 'Baking', 'Condiments', 'Stocks/Gravies', 'Seasoning', 'Bread', 'Frozen Meat', 'Prepared Meals', 'Frozen Veg', 'Fresh Fruit', 'Fresh Veg', 'Dairy', 'Baked Goods', 'Giveaways', 'Toiletries', 'Showers', 'Misc'],

            async init() {
                this.loadCategories();
                await this.loadData();
                this.loadUsageHistory();
                this.loadProjectFoods();
                this.render();
                
                if (!useLocalStorage && supabase) {
                    try {
                        supabase.channel('inventory_changes').on('postgres_changes', 
                            { event: '*', schema: 'public', table: 'inventory' }, 
                            () => this.loadData()
                        ).subscribe();
                    } catch (e) {
                        console.log('Real-time subscription failed:', e);
                    }
                }
                
                setInterval(() => this.autoBackup(), 300000);
                this.createBackup();
            },

            loadCategories() {
                const saved = localStorage.getItem('uts-categories');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            this.categories = parsed;
                        }
                    } catch (e) {
                        console.error('Error loading categories:', e);
                    }
                }
            },

            saveCategories() {
                localStorage.setItem('uts-categories', JSON.stringify(this.categories));
            },

            addCategory() {
                const name = prompt('Enter new category name:');
                if (!name || !name.trim()) return;
                
                const trimmed = name.trim();
                if (this.categories.includes(trimmed)) {
                    alert('Category already exists!');
                    return;
                }
                
                this.categories.push(trimmed);
                this.saveCategories();
                this.showNotification('Category added!');
                this.render();
            },

            deleteCategory(category) {
                if (category === 'All') {
                    alert('Cannot delete "All" category');
                    return;
                }
                
                const hasItems = this.items.some(item => item.category === category);
                if (hasItems) {
                    alert('Cannot delete category with items in it. Please move or delete those items first.');
                    return;
                }
                
                if (!confirm(`Delete category "${category}"?`)) return;
                
                this.categories = this.categories.filter(c => c !== category);
                this.saveCategories();
                this.showNotification('Category deleted');
                this.render();
            },

            toggleCompactView() {
                this.compactView = !this.compactView;
                this.render();
            },

            validateData(data) {
                if (!Array.isArray(data)) return false;
                for (let item of data) {
                    if (!item.name || typeof item.name !== 'string') return false;
                    if (typeof item.quantity !== 'number') return false;
                }
                return true;
            },

            createBackup() {
                try {
                    const timestamp = new Date().toISOString();
                    const backup = {
                        items: this.items,
                        usageHistory: this.usageHistory,
                        projectFoods: this.projectFoods,
                        categories: this.categories,
                        timestamp: timestamp,
                        version: '2.1'
                    };
                    const backups = this.getBackups();
                    backups.push(backup);
                    if (backups.length > this.backupCount) backups.shift();
                    localStorage.setItem('uts-inventory-backups', JSON.stringify(backups));
                    console.log('Backup created:', timestamp);
                } catch (e) {
                    console.error('Backup creation failed:', e);
                }
            },

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-inventory-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

            restoreFromBackup() {
                const backups = this.getBackups();
                for (let i = backups.length - 1; i >= 0; i--) {
                    const backup = backups[i];
                    if (backup.items && this.validateData(backup.items)) {
                        this.items = backup.items;
                        this.usageHistory = backup.usageHistory || [];
                        this.projectFoods = backup.projectFoods || [];
                        if (backup.categories) this.categories = backup.categories;
                        this.showNotification('Restored from backup: ' + new Date(backup.timestamp).toLocaleString(), 'success');
                        return true;
                    }
                }
                this.showNotification('No valid backups found', 'error');
                return false;
            },

            autoBackup() {
                if (!this.validateData(this.items)) {
                    console.error('Data validation failed - backup skipped');
                    return;
                }
                this.createBackup();
            },

            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            },

            async loadData() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-inventory');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (this.validateData(parsed)) {
                                this.items = parsed;
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        } catch (e) {
                            this.restoreFromBackup();
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').select('*').order('name');
                        if (error) {
                            console.error('Supabase load error:', error);
                            throw error;
                        }
                        if (data) {
                            if (this.validateData(data)) {
                                this.items = data;
                                localStorage.setItem('uts-inventory', JSON.stringify(data));
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        }
                    } catch (e) {
                        console.error('Error loading from database:', e);
                        const saved = localStorage.getItem('uts-inventory');
                        if (saved) {
                            try {
                                this.items = JSON.parse(saved);
                            } catch (parseError) {
                                this.restoreFromBackup();
                            }
                        }
                    }
                }
                this.render();
            },

            loadUsageHistory() {
                const saved = localStorage.getItem('uts-usage-history');
                if (saved) {
                    try {
                        this.usageHistory = JSON.parse(saved);
                    } catch (e) {
                        this.usageHistory = [];
                    }
                }
            },

            saveUsageHistory() {
                localStorage.setItem('uts-usage-history', JSON.stringify(this.usageHistory));
            },

            recordUsage(itemId, itemName, change) {
                if (change !== 0) {
                    const item = this.items.find(i => i.id === itemId);
                    if (item) {
                        item.lastUpdated = new Date().toISOString();
                    }
                }
                if (change < 0) {
                    this.usageHistory.push({
                        itemId: itemId,
                        itemName: itemName,
                        quantity: Math.abs(change),
                        timestamp: new Date().toISOString()
                    });
                    this.saveUsageHistory();
                }
            },

            loadProjectFoods() {
                const saved = localStorage.getItem('uts-project-foods');
                if (saved) {
                    try {
                        this.projectFoods = JSON.parse(saved);
                    } catch (e) {
                        this.projectFoods = [];
                    }
                }
            },

            saveProjectFoods() {
                localStorage.setItem('uts-project-foods', JSON.stringify(this.projectFoods));
            },

            async save() {
                localStorage.setItem('uts-inventory', JSON.stringify(this.items));
            },

            toggleAddForm() {
                const formVisible = document.getElementById('addForm')?.classList.contains('hidden') === false;
                this.editingItemId = null;
                this.render(!formVisible);
                if (!formVisible) {
                    setTimeout(() => {
                        document.getElementById('addForm')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            },

            startEditItem(id) {
                this.editingItemId = id;
                this.render();
                setTimeout(() => {
                    document.getElementById(`edit-form-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            },

            cancelEdit() {
                this.editingItemId = null;
                this.render();
            },

            async addItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                const item = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 0,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null
                };

                if (useLocalStorage) {
                    item.id = Date.now();
                    item.lastUpdated = new Date().toISOString();
                    this.items.push(item);
                    await this.save();
                    this.createBackup();
                    this.showNotification('âœ“ Item added!');
                    this.toggleAddForm();
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').insert([item]).select();
                        if (error) {
                            console.error('Insert error:', error);
                            throw error;
                        }
                        await this.loadData();
                        this.showNotification('âœ“ Item added!');
                        this.toggleAddForm();
                    } catch (e) {
                        console.error('Full error:', e);
                        alert('Error saving item: ' + e.message);
                        return;
                    }
                }
            },

            async updateItem(id) {
                const name = document.getElementById(`editName-${id}`).value.trim();
                if (!name) return alert('Please enter item name');

                const updatedItem = {
                    name: name,
                    category: document.getElementById(`editCategory-${id}`).value,
                    quantity: parseInt(document.getElementById(`editQuantity-${id}`).value) || 0,
                    unit: document.getElementById(`editUnit-${id}`).value,
                    minstock: parseInt(document.getElementById(`editMinStock-${id}`).value) || 0,
                    expirydate: document.getElementById(`editExpiry-${id}`).value || null,
                    location: document.getElementById(`editLocation-${id}`).value.trim() || null,
                    notes: document.getElementById(`editNotes-${id}`).value.trim() || null
                };

                if (useLocalStorage) {
                    const item = this.items.find(i => i.id === id);
                    if (item) {
                        Object.assign(item, updatedItem);
                        item.lastUpdated = new Date().toISOString();
                        await this.save();
                        this.createBackup();
                    }
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update(updatedItem).eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating item: ' + e.message);
                        return;
                    }
                }

                this.showNotification('âœ“ Item updated!');
                this.editingItemId = null;
                this.render();
            },

            async updateQuantity(id, change) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;

                const newQty = Math.max(0, item.quantity + change);
                this.recordUsage(id, item.name, change);

                if (useLocalStorage) {
                    item.quantity = newQty;
                    await this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update({ 
                            quantity: newQty
                        }).eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating quantity: ' + e.message);
                    }
                }
            },

            async deleteItem(id) {
                if (!confirm('Remove this item from inventory?')) return;

                if (useLocalStorage) {
                    this.items = this.items.filter(i => i.id !== id);
                    await this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').delete().eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error deleting item: ' + e.message);
                    }
                }
                this.showNotification('Item deleted');
            },

            getItemStatus(item) {
                if (item.quantity === 0 && (item.minstock || 0) > 0) return { color: 'bg-red-100 border-red-300', text: 'OUT OF STOCK' };
                if ((item.minstock || 0) > 0 && item.quantity <= item.minstock) return { color: 'bg-orange-100 border-orange-300', text: 'LOW STOCK' };
                
                if (item.expirydate) {
                    const days = Math.ceil((new Date(item.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (days < 0) return { color: 'bg-red-100 border-red-300', text: 'EXPIRED' };
                    if (days <= 7) return { color: 'bg-yellow-100 border-yellow-300', text: `EXPIRES IN ${days}D` };
                }
                
                return { color: 'bg-white border-gray-200', text: '' };
            },

            isRecentlyUpdated(item) {
                if (!item.lastUpdated) return false;
                const hoursSince = (new Date() - new Date(item.lastUpdated)) / (1000 * 60 * 60);
                return hoursSince < 24;
            },

            exportToCSV() {
                const rows = [['Name', 'Category', 'Quantity', 'Unit', 'Min Stock', 'Location', 'Expiry Date', 'Status', 'Notes']];
                
                this.items.forEach(item => {
                    const status = this.getItemStatus(item);
                    rows.push([
                        item.name,
                        item.category,
                        item.quantity,
                        item.unit,
                        item.minstock || 0,
                        item.location || '',
                        item.expirydate || '',
                        status.text,
                        item.notes || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported!');
            },

            generateShoppingList() {
                const needsRestock = this.items.filter(item => (item.minstock || 0) > 0 && item.quantity <= item.minstock);
                return needsRestock.sort((a, b) => a.category.localeCompare(b.category));
            },

            emailShoppingList() {
                const list = this.generateShoppingList();
                let body = 'UTS Inventory Shopping List\n\n';
                body += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                const byCategory = {};
                list.forEach(item => {
                    if (!byCategory[item.category]) byCategory[item.category] = [];
                    byCategory[item.category].push(item);
                });
                
                Object.keys(byCategory).sort().forEach(category => {
                    body += `${category}:\n`;
                    byCategory[category].forEach(item => {
                        body += `  â€¢ ${item.name} - Current: ${item.quantity} ${item.unit}, Need: ${item.minstock} ${item.unit}\n`;
                    });
                    body += '\n';
                });
                
                const mailto = `mailto:operations@underthestars.org.nz?subject=UTS Shopping List - ${new Date().toLocaleDateString()}&body=${encodeURIComponent(body)}`;
                window.location.href = mailto;
            },

            downloadShoppingList() {
                const list = this.generateShoppingList();
                const rows = [['Item', 'Category', 'Current Stock', 'Min Stock', 'Location']];
                
                list.forEach(item => {
                    rows.push([
                        item.name,
                        item.category,
                        `${item.quantity} ${item.unit}`,
                        `${item.minstock} ${item.unit}`,
                        item.location || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-shopping-list-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Shopping list downloaded!');
            },

            getConsumptionReport() {
                const last30Days = new Date();
                last30Days.setDate(last30Days.getDate() - 30);
                
                const recentUsage = this.usageHistory.filter(h => new Date(h.timestamp) >= last30Days);
                
                const byItem = {};
                recentUsage.forEach(usage => {
                    if (!byItem[usage.itemName]) {
                        byItem[usage.itemName] = { total: 0, count: 0 };
                    }
                    byItem[usage.itemName].total += usage.quantity;
                    byItem[usage.itemName].count++;
                });
                
                return Object.keys(byItem).map(itemName => ({
                    itemName,
                    totalUsed: byItem[itemName].total,
                    timesUsed: byItem[itemName].count,
                    avgPerUse: (byItem[itemName].total / byItem[itemName].count).toFixed(1)
                })).sort((a, b) => b.totalUsed - a.totalUsed);
            },

            addProjectFood() {
                const name = document.getElementById('projectFoodName').value.trim();
                const cost = parseFloat(document.getElementById('projectFoodCost').value);
                const date = document.getElementById('projectFoodDate').value;
                const project = document.getElementById('projectFoodProject').value.trim();
                
                if (!name || !cost || !date || !project) return alert('Please fill all fields');
                
                this.projectFoods.push({
                    id: Date.now(),
                    name: name,
                    cost: cost,
                    date: date,
                    project: project,
                    timestamp: new Date().toISOString()
                });
                
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Project food cost added!');
                
                document.getElementById('projectFoodName').value = '';
                document.getElementById('projectFoodCost').value = '';
                document.getElementById('projectFoodDate').value = '';
                document.getElementById('projectFoodProject').value = '';
                
                this.render();
            },

            deleteProjectFood(id) {
                if (!confirm('Delete this project food entry?')) return;
                this.projectFoods = this.projectFoods.filter(p => p.id !== id);
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Entry deleted');
                this.render();
            },

            loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.currentView = 'admin';
                    this.render();
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

            logoutAdmin() {
                this.isAdmin = false;
                this.currentView = 'inventory';
                this.render();
            },

            downloadBackup() {
                const backup = {
                    items: this.items,
                    usageHistory: this.usageHistory,
                    projectFoods: this.projectFoods,
                    categories: this.categories,
                    timestamp: new Date().toISOString(),
                    version: '2.1'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.items && this.validateData(backup.items)) {
                                this.items = backup.items;
                                this.usageHistory = backup.usageHistory || [];
                                this.projectFoods = backup.projectFoods || [];
                                if (backup.categories) this.categories = backup.categories;
                                this.save();
                                this.saveUsageHistory();
                                this.saveProjectFoods();
                                this.saveCategories();
                                this.createBackup();
                                this.showNotification('Backup restored!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            render(showAddForm = false) {
                const appEl = document.getElementById('app');
                
                if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else {
                    appEl.innerHTML = this.renderInventory(showAddForm);
                }
            },

            renderAdmin() {
                const shoppingList = this.generateShoppingList();
                const consumption = this.getConsumptionReport();
                
                const projectTotals = {};
                this.projectFoods.forEach(p => {
                    if (!projectTotals[p.project]) {
                        projectTotals[p.project] = 0;
                    }
                    projectTotals[p.project] += p.cost;
                });
                const totalProjectCosts = this.projectFoods.reduce((sum, p) => sum + p.cost, 0);
                
                const stats = {
                    total: this.items.length,
                    lowStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity <= i.minstock && i.quantity > 0).length,
                    outOfStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity === 0).length,
                    expiringSoon: this.items.filter(i => {
                        if (!i.expirydate) return false;
                        const days = Math.ceil((new Date(i.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days >= 0 && days <= 7;
                    }).length
                };

                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-7xl mx-auto">
                            ${!useLocalStorage ? '<div class="bg-blue-100 text-blue-800 p-3 rounded mb-4 text-sm text-center font-semibold">âœ“ Supabase Connected</div>' : '<div class="bg-yellow-100 text-yellow-800 p-3 rounded mb-4 text-sm text-center font-semibold">âš  Local Storage Mode</div>'}
                            
                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                                    <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                                    <div class="flex gap-2 flex-wrap">
                                        <button onclick="app.currentView='inventory'; app.render();" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Back</button>
                                        <button onclick="app.logoutAdmin()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Logout</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
                                        <div class="text-xs text-gray-600">Total Items</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-orange-600">${stats.lowStock}</div>
                                        <div class="text-xs text-gray-600">Low Stock</div>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-red-600">${stats.outOfStock}</div>
                                        <div class="text-xs text-gray-600">Out of Stock</div>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-yellow-600">${stats.expiringSoon}</div>
                                        <div class="text-xs text-gray-600">Expiring Soon</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <button onclick="app.exportToCSV()" class="bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 text-sm">
                                        ðŸ“Š Export
                                    </button>
                                    <button onclick="app.downloadBackup()" class="bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 text-sm">
                                        ðŸ’¾ Backup
                                    </button>
                                    <button onclick="app.uploadBackup()" class="bg-orange-600 text-white p-3 rounded-lg font-bold hover:bg-orange-700 text-sm">
                                        ðŸ“¤ Restore
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold">Categories</h2>
                                    <button onclick="app.addCategory()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                                        + Add
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${this.categories.filter(c => c !== 'All').map(cat => `
                                        <div class="flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-lg">
                                            <span class="text-sm">${cat}</span>
                                            <button onclick="app.deleteCategory('${cat}')" class="text-red-600 hover:text-red-800 font-bold">Ã—</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                                    <h2 class="text-xl font-bold">Shopping List (${shoppingList.length})</h2>
                                    <div class="flex gap-2">
                                        <button onclick="app.downloadShoppingList()" class="bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                                            ðŸ“¥ CSV
                                        </button>
                                        <button onclick="app.emailShoppingList()" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 text-sm">
                                            ðŸ“§ Email
                                        </button>
                                    </div>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    ${shoppingList.length === 0 ? '<p class="text-gray-500 text-center py-8 text-sm">All stocked! ðŸŽ‰</p>' : `
                                        <div class="space-y-2">
                                            ${shoppingList.map(item => `
                                                <div class="border-b pb-2">
                                                    <div class="font-semibold text-sm">${item.name}</div>
                                                    <div class="text-xs text-gray-600">${item.category} â€¢ Current: ${item.quantity} ${item.unit} â€¢ Need: ${item.minstock} ${item.unit}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4">Consumption (30 Days)</h2>
                                <div class="max-h-96 overflow-y-auto">
                                    ${consumption.length === 0 ? '<p class="text-gray-500 text-center py-8 text-sm">No usage data yet</p>' : `
                                        <div class="space-y-2">
                                            ${consumption.slice(0, 10).map(item => `
                                                <div class="border-b pb-2">
                                                    <div class="font-semibold text-sm">${item.itemName}</div>
                                                    <div class="text-xs text-gray-600">Used: ${item.totalUsed} â€¢ Times: ${item.timesUsed} â€¢ Avg: ${item.avgPerUse}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h2 class="text-xl font-bold mb-4">Project Food Costs</h2>
                                <div class="bg-green-50 p-4 rounded-lg mb-4">
                                    <div class="text-2xl font-bold text-green-600">${totalProjectCosts.toFixed(2)}</div>
                                    <div class="text-xs text-gray-600">Total</div>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-3 mb-4">
                                    <input type="text" id="projectFoodName" placeholder="Item name" class="border rounded-lg px-4 py-2 text-sm">
                                    <input type="number" id="projectFoodCost" placeholder="Cost ($)" step="0.01" class="border rounded-lg px-4 py-2 text-sm">
                                    <input type="date" id="projectFoodDate" class="border rounded-lg px-4 py-2 text-sm">
                                    <input type="text" id="projectFoodProject" placeholder="Project name" class="border rounded-lg px-4 py-2 text-sm">
                                </div>
                                <button onclick="app.addProjectFood()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 w-full text-sm">
                                    Add Cost
                                </button>

                                <div class="max-h-96 overflow-y-auto mt-4">
                                    ${this.projectFoods.length === 0 ? '<p class="text-gray-500 text-center py-8 text-sm">No costs recorded</p>' : `
                                        <div class="space-y-2">
                                            ${this.projectFoods.sort((a, b) => new Date(b.date) - new Date(a.date)).map(item => `
                                                <div class="border-b pb-2 flex justify-between items-start">
                                                    <div>
                                                        <div class="font-semibold text-sm">${item.name}</div>
                                                        <div class="text-xs text-gray-600">${item.project} â€¢ ${new Date(item.date).toLocaleDateString()}</div>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-green-600 font-bold text-sm">${item.cost.toFixed(2)}</span>
                                                        <button onclick="app.deleteProjectFood(${item.id})" class="text-red-600 hover:text-red-800 text-xs">Delete</button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderInventory(showAddForm) {
                const searchTerm = document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
                const filtered = this.items.filter(item => {
                    const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                    const matchesCategory = this.selectedCategory === 'All' || item.category === this.selectedCategory;
                    return matchesSearch && matchesCategory;
                }).sort((a, b) => a.name.localeCompare(b.name));

                const stats = {
                    total: this.items.length,
                    lowStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity <= i.minstock && i.quantity > 0).length,
                    outOfStock: this.items.filter(i => (i.minstock || 0) > 0 && i.quantity === 0).length,
                    expiringSoon: this.items.filter(i => {
                        if (!i.expirydate) return false;
                        const days = Math.ceil((new Date(i.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days >= 0 && days <= 7;
                    }).length
                };

                return `
                    <div class="min-h-screen p-4 pb-20">
                        <div class="max-w-6xl mx-auto">
                            ${!useLocalStorage ? '<div class="bg-blue-100 text-blue-800 p-2 rounded-lg mb-4 text-xs text-center font-semibold">âœ“ Supabase</div>' : '<div class="bg-yellow-100 text-yellow-800 p-2 rounded-lg mb-4 text-xs text-center font-semibold">âš  Local</div>'}
                            
                            <div class="bg-white rounded-lg shadow-md p-4 mb-4">
                                <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
                                    <h1 class="text-2xl font-bold text-gray-800">UTS Inventory</h1>
                                    <div class="flex gap-2 flex-wrap">
                                        ${this.isAdmin ? '<button onclick="app.currentView=\'admin\'; app.render();" class="bg-purple-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-purple-700 text-xs">Admin</button>' : ''}
                                        ${!this.isAdmin ? '<button onclick="app.loginAdmin()" class="text-gray-400 hover:text-gray-600 text-xs px-2 py-1">Admin</button>' : ''}
                                        <button onclick="app.toggleCompactView()" class="bg-gray-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-gray-700 text-xs">
                                            ${this.compactView ? 'ðŸ“‹ Normal' : 'ðŸ“Š Compact'}
                                        </button>
                                        <button onclick="app.exportData()" class="bg-gray-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-gray-700 text-xs">Export</button>
                                        <button onclick="app.toggleAddForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 text-sm">+ Add</button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <div class="text-xl font-bold text-blue-600">${stats.total}</div>
                                        <div class="text-xs text-gray-600">Total</div>
                                    </div>
                                    <div class="bg-orange-50 p-3 rounded-lg">
                                        <div class="text-xl font-bold text-orange-600">${stats.lowStock}</div>
                                        <div class="text-xs text-gray-600">Low</div>
                                    </div>
                                    <div class="bg-red-50 p-3 rounded-lg">
                                        <div class="text-xl font-bold text-red-600">${stats.outOfStock}</div>
                                        <div class="text-xs text-gray-600">Out</div>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <div class="text-xl font-bold text-yellow-600">${stats.expiringSoon}</div>
                                        <div class="text-xs text-gray-600">Expiring</div>
                                    </div>
                                </div>
                            </div>

                            <div id="addForm" class="bg-white rounded-lg shadow-md p-4 mb-4 ${showAddForm ? '' : 'hidden'}">
                                <h2 class="text-lg font-bold mb-3">âž• Add New Item</h2>
                                <div class="grid grid-cols-1 gap-3 mb-3">
                                    <input type="text" id="itemName" placeholder="Item name *" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <select id="itemCategory" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        ${this.categories.filter(c => c !== 'All').map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                    </select>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="itemQuantity" placeholder="Quantity" value="0" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <select id="itemUnit" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="units">units</option>
                                            <option value="kg">kg</option>
                                            <option value="g">g</option>
                                            <option value="liters">liters</option>
                                            <option value="boxes">boxes</option>
                                            <option value="bags">bags</option>
                                            <option value="cans">cans</option>
                                            <option value="packets">packets</option>
                                            <option value="bottles">bottles</option>
                                        </select>
                                    </div>
                                    <input type="number" id="itemMinStock" placeholder="Min stock (0 = no alert)" value="0" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <input type="date" id="itemExpiry" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <input type="text" id="itemLocation" placeholder="Location" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <textarea id="itemNotes" placeholder="Notes" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
                                </div>
                                <button onclick="app.addItem()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700">
                                    âœ“ Add Item
                                </button>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-4 mb-4 sticky top-0 z-10">
                                <div class="mb-3">
                                    <input type="text" id="searchInput" placeholder="ðŸ” Search..." oninput="app.render()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div class="flex gap-2 overflow-x-auto pb-2">
                                    ${this.categories.map(cat => `
                                        <button onclick="app.selectedCategory='${cat}'; app.render()" 
                                            class="px-3 py-1 rounded-lg text-sm font-medium whitespace-nowrap ${
                                                this.selectedCategory === cat
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-gray-100 text-gray-700'
                                            }">
                                            ${cat}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="space-y-3">
                                ${filtered.length === 0 ? `
                                    <div class="bg-white rounded-lg shadow-md p-12 text-center">
                                        <p class="text-gray-500">
                                            ${this.items.length === 0 ? 'No items yet. Click "+ Add"!' : 'No matches.'}
                                        </p>
                                    </div>
                                ` : filtered.map(item => {
                                    const status = this.getItemStatus(item);
                                    const isRecent = this.isRecentlyUpdated(item);
                                    const isEditing = this.editingItemId === item.id;
                                    
                                    if (isEditing) {
                                        return `
                                            <div id="edit-form-${item.id}" class="bg-blue-50 border-2 border-blue-400 rounded-lg p-4">
                                                <h3 class="text-lg font-bold mb-3">âœï¸ Editing: ${item.name}</h3>
                                                <div class="grid grid-cols-1 gap-3 mb-3">
                                                    <input type="text" id="editName-${item.id}" value="${item.name}" class="border rounded-lg px-3 py-2">
                                                    <select id="editCategory-${item.id}" class="border rounded-lg px-3 py-2">
                                                        ${this.categories.filter(c => c !== 'All').map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                                    </select>
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <input type="number" id="editQuantity-${item.id}" value="${item.quantity}" class="border rounded-lg px-3 py-2">
                                                        <select id="editUnit-${item.id}" class="border rounded-lg px-3 py-2">
                                                            <option value="units" ${item.unit === 'units' ? 'selected' : ''}>units</option>
                                                            <option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option>
                                                            <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option>
                                                            <option value="liters" ${item.unit === 'liters' ? 'selected' : ''}>liters</option>
                                                            <option value="boxes" ${item.unit === 'boxes' ? 'selected' : ''}>boxes</option>
                                                            <option value="bags" ${item.unit === 'bags' ? 'selected' : ''}>bags</option>
                                                            <option value="cans" ${item.unit === 'cans' ? 'selected' : ''}>cans</option>
                                                            <option value="packets" ${item.unit === 'packets' ? 'selected' : ''}>packets</option>
                                                            <option value="bottles" ${item.unit === 'bottles' ? 'selected' : ''}>bottles</option>
                                                        </select>
                                                    </div>
                                                    <input type="number" id="editMinStock-${item.id}" value="${item.minstock || 0}" placeholder="Min stock" class="border rounded-lg px-3 py-2">
                                                    <input type="date" id="editExpiry-${item.id}" value="${item.expirydate || ''}" class="border rounded-lg px-3 py-2">
                                                    <input type="text" id="editLocation-${item.id}" value="${item.location || ''}" placeholder="Location" class="border rounded-lg px-3 py-2">
                                                    <textarea id="editNotes-${item.id}" placeholder="Notes" class="border rounded-lg px-3 py-2" rows="2">${item.notes || ''}</textarea>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="app.updateItem(${item.id})" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700">
                                                        âœ“ Save
                                                    </button>
                                                    <button onclick="app.cancelEdit()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-600">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    return `
                                        <div class="${status.color} border-2 rounded-lg p-3">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                        <h3 class="text-lg font-bold text-gray-800">${item.name}</h3>
                                                        ${isRecent ? '<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full">NEW</span>' : ''}
                                                        <span class="text-xs px-2 py-0.5 bg-gray-200 rounded-full text-gray-600">${item.category}</span>
                                                        ${item.location ? `<span class="text-xs px-2 py-0.5 bg-blue-100 rounded-full text-blue-700">ðŸ“ ${item.location}</span>` : ''}
                                                    </div>
                                                    <div class="text-base font-bold ${item.quantity === 0 && (item.minstock || 0) > 0 ? 'text-red-600' : 'text-gray-800'}">
                                                        ${item.quantity} ${item.unit}
                                                    </div>
                                                    ${item.expirydate ? `<div class="text-xs text-gray-600">Exp: ${new Date(item.expirydate).toLocaleDateString()}</div>` : ''}
                                                    ${item.notes ? `<div class="text-xs text-gray-600 italic mt-1">ðŸ“ ${item.notes}</div>` : ''}
                                                    ${status.text ? `
                                                        <div class="inline-flex items-center gap-1 mt-1 bg-orange-50 px-2 py-1 rounded text-xs font-bold text-orange-700">
                                                            âš  ${status.text}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            
                                            <div class="flex gap-2 mb-2">
                                                <button onclick="toggleQuantityDropdown(${item.id})" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 font-semibold text-sm">
                                                    Â± Adjust Qty
                                                </button>
                                                <button onclick="app.startEditItem(${item.id})" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 font-semibold text-sm">
                                                    âœï¸
                                                </button>
                                                <button onclick="app.deleteItem(${item.id})" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 font-semibold text-sm">
                                                    ðŸ—‘ï¸
                                                </button>
                                            </div>
                                            
                                            <div id="qty-${item.id}" class="quantity-dropdown grid-cols-3 gap-2">
                                                <button onclick="app.updateQuantity(${item.id}, -10)" class="bg-red-600 text-white px-2 py-2 rounded font-bold text-sm">-10</button>
                                                <button onclick="app.updateQuantity(${item.id}, -5)" class="bg-red-500 text-white px-2 py-2 rounded font-bold text-sm">-5</button>
                                                <button onclick="app.updateQuantity(${item.id}, -1)" class="bg-red-400 text-white px-2 py-2 rounded font-bold text-sm">-1</button>
                                                <button onclick="app.updateQuantity(${item.id}, 1)" class="bg-green-400 text-white px-2 py-2 rounded font-bold text-sm">+1</button>
                                                <button onclick="app.updateQuantity(${item.id}, 5)" class="bg-green-500 text-white px-2 py-2 rounded font-bold text-sm">+5</button>
                                                <button onclick="app.updateQuantity(${item.id}, 10)" class="bg-green-600 text-white px-2 py-2 rounded font-bold text-sm">+10</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            exportData() {
                this.exportToCSV();
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
