<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTS Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://slelvrwtokiqlhletpsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZWx2cnd0b2tpcWxobGV0cHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODM3MTEsImV4cCI6MjA3NzM1OTcxMX0.mvO2vGyMlvmeV0tn60RL9dbzKkScBfXcFqMY-rTBmHM';
        const ADMIN_PASSWORD = 'UTS2025Admin';
        
        let supabase = null;
        let useLocalStorage = true;

        if (SUPABASE_URL && SUPABASE_KEY) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                useLocalStorage = false;
            } catch (e) {
                console.log('Using local storage mode');
            }
        }

        const app = {
            items: [],
            usageHistory: [],
            projectFoods: [],
            selectedCategory: 'All',
            currentView: 'inventory',
            isAdmin: false,
            backupCount: 10,
            editingItemId: null,
            categories: ['All', 'Pasta/Grain', 'Canned Goods', 'Disposables', 'Equipment', 'Baking', 'Condiments', 'Stocks/Gravies', 'Seasoning', 'Bread', 'Frozen Meat', 'Prepared Meals', 'Frozen Veg', 'Fresh Fruit', 'Fresh Veg', 'Dairy', 'Baked Goods', 'Giveaways', 'Toiletries', 'Showers', 'Misc'],

            async init() {
                await this.loadData();
                this.loadUsageHistory();
                this.loadProjectFoods();
                this.render();
                
                if (!useLocalStorage && supabase) {
                    supabase.channel('inventory_changes').on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'inventory' }, 
                        () => this.loadData()
                    ).subscribe();
                }
                
                setInterval(() => this.autoBackup(), 300000);
                this.createBackup();
            },

            validateData(data) {
                if (!Array.isArray(data)) return false;
                for (let item of data) {
                    if (!item.name || typeof item.name !== 'string') return false;
                    if (typeof item.quantity !== 'number') return false;
                }
                return true;
            },

            createBackup() {
                try {
                    const timestamp = new Date().toISOString();
                    const backup = {
                        items: this.items,
                        usageHistory: this.usageHistory,
                        projectFoods: this.projectFoods,
                        timestamp: timestamp,
                        version: '2.0'
                    };
                    const backups = this.getBackups();
                    backups.push(backup);
                    if (backups.length > this.backupCount) backups.shift();
                    localStorage.setItem('uts-inventory-backups', JSON.stringify(backups));
                    console.log('Backup created:', timestamp);
                } catch (e) {
                    console.error('Backup creation failed:', e);
                }
            },

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-inventory-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

            restoreFromBackup() {
                const backups = this.getBackups();
                for (let i = backups.length - 1; i >= 0; i--) {
                    const backup = backups[i];
                    if (backup.items && this.validateData(backup.items)) {
                        this.items = backup.items;
                        this.usageHistory = backup.usageHistory || [];
                        this.projectFoods = backup.projectFoods || [];
                        this.showNotification('Restored from backup: ' + new Date(backup.timestamp).toLocaleString(), 'success');
                        return true;
                    }
                }
                this.showNotification('No valid backups found', 'error');
                return false;
            },

            autoBackup() {
                if (!this.validateData(this.items)) {
                    console.error('Data validation failed - backup skipped');
                    return;
                }
                this.createBackup();
            },

            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            },

            async loadData() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-inventory');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (this.validateData(parsed)) {
                                this.items = parsed;
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        } catch (e) {
                            this.restoreFromBackup();
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').select('*').order('name');
                        if (!error && data) {
                            if (this.validateData(data)) {
                                this.items = data;
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        }
                    } catch (e) {
                        console.error('Error loading from database:', e);
                        this.restoreFromBackup();
                    }
                }
                this.render();
            },

            loadUsageHistory() {
                const saved = localStorage.getItem('uts-usage-history');
                if (saved) {
                    try {
                        this.usageHistory = JSON.parse(saved);
                    } catch (e) {
                        this.usageHistory = [];
                    }
                }
            },

            saveUsageHistory() {
                localStorage.setItem('uts-usage-history', JSON.stringify(this.usageHistory));
            },

            recordUsage(itemId, itemName, change) {
                if (change < 0) {
                    this.usageHistory.push({
                        itemId: itemId,
                        itemName: itemName,
                        quantity: Math.abs(change),
                        timestamp: new Date().toISOString()
                    });
                    this.saveUsageHistory();
                }
            },

            loadProjectFoods() {
                const saved = localStorage.getItem('uts-project-foods');
                if (saved) {
                    try {
                        this.projectFoods = JSON.parse(saved);
                    } catch (e) {
                        this.projectFoods = [];
                    }
                }
            },

            saveProjectFoods() {
                localStorage.setItem('uts-project-foods', JSON.stringify(this.projectFoods));
            },

            async save() {
                if (useLocalStorage) {
                    localStorage.setItem('uts-inventory', JSON.stringify(this.items));
                }
            },

            toggleAddForm() {
                const formVisible = document.getElementById('addForm')?.classList.contains('hidden') === false;
                this.editingItemId = null;
                this.render(!formVisible);
            },

            startEditItem(id) {
                this.editingItemId = id;
                this.render(true);
            },

            cancelEdit() {
                this.editingItemId = null;
                this.render(false);
            },

            async addItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                const item = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 5,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null
                };

                if (useLocalStorage) {
                    item.id = Date.now();
                    this.items.push(item);
                    this.save();
                    this.createBackup();
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').insert([item]).select();
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error saving item: ' + e.message);
                        return;
                    }
                }
                
                this.showNotification('Item added successfully!');
                this.toggleAddForm();
            },

            async updateItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                const updatedItem = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 5,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null
                };

                if (useLocalStorage) {
                    const item = this.items.find(i => i.id === this.editingItemId);
                    if (item) {
                        Object.assign(item, updatedItem);
                        this.save();
                        this.createBackup();
                    }
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update(updatedItem).eq('id', this.editingItemId);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating item: ' + e.message);
                        return;
                    }
                }

                this.showNotification('Item updated successfully!');
                this.editingItemId = null;
                this.render(false);
            },

            async updateQuantity(id, change) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;

                const newQty = Math.max(0, item.quantity + change);
                this.recordUsage(id, item.name, change);

                if (useLocalStorage) {
                    item.quantity = newQty;
                    this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating quantity: ' + e.message);
                    }
                }
            },

            async deleteItem(id) {
                if (!confirm('Remove this item from inventory?')) return;

                if (useLocalStorage) {
                    this.items = this.items.filter(i => i.id !== id);
                    this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').delete().eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error deleting item: ' + e.message);
                    }
                }
                this.showNotification('Item deleted');
            },

            getItemStatus(item) {
                if (item.quantity === 0) return { color: 'bg-red-100 border-red-300', text: 'OUT OF STOCK' };
                if (item.quantity <= (item.minstock || 5)) return { color: 'bg-orange-100 border-orange-300', text: 'LOW STOCK' };
                
                if (item.expirydate) {
                    const days = Math.ceil((new Date(item.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (days < 0) return { color: 'bg-red-100 border-red-300', text: 'EXPIRED' };
                    if (days <= 7) return { color: 'bg-yellow-100 border-yellow-300', text: `EXPIRES IN ${days}D` };
                }
                
                return { color: 'bg-white border-gray-200', text: '' };
            },

            exportToCSV() {
                const rows = [['Name', 'Category', 'Quantity', 'Unit', 'Min Stock', 'Location', 'Expiry Date', 'Status', 'Notes']];
                
                this.items.forEach(item => {
                    const status = this.getItemStatus(item);
                    rows.push([
                        item.name,
                        item.category,
                        item.quantity,
                        item.unit,
                        item.minstock || 5,
                        item.location || '',
                        item.expirydate || '',
                        status.text,
                        item.notes || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported successfully!');
            },

            generateShoppingList() {
                const needsRestock = this.items.filter(item => item.quantity <= (item.minstock || 5));
                return needsRestock.sort((a, b) => a.category.localeCompare(b.category));
            },

            emailShoppingList() {
                const list = this.generateShoppingList();
                let body = 'UTS Inventory Shopping List\n\n';
                body += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                const byCategory = {};
                list.forEach(item => {
                    if (!byCategory[item.category]) byCategory[item.category] = [];
                    byCategory[item.category].push(item);
                });
                
                Object.keys(byCategory).sort().forEach(category => {
                    body += `${category}:\n`;
                    byCategory[category].forEach(item => {
                        body += `  â€¢ ${item.name} - Current: ${item.quantity} ${item.unit}, Need: ${item.minstock || 5} ${item.unit}\n`;
                    });
                    body += '\n';
                });
                
                const mailto = `mailto:operations@underthestars.org.nz?subject=UTS Shopping List - ${new Date().toLocaleDateString()}&body=${encodeURIComponent(body)}`;
                window.location.href = mailto;
            },

            downloadShoppingList() {
                const list = this.generateShoppingList();
                const rows = [['Item', 'Category', 'Current Stock', 'Min Stock', 'Location']];
                
                list.forEach(item => {
                    rows.push([
                        item.name,
                        item.category,
                        `${item.quantity} ${item.unit}`,
                        `${item.minstock || 5} ${item.unit}`,
                        item.location || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-shopping-list-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Shopping list downloaded!');
            },

            getConsumptionReport() {
                const last30Days = new Date();
                last30Days.setDate(last30Days.getDate() - 30);
                
                const recentUsage = this.usageHistory.filter(h => new Date(h.timestamp) >= last30Days);
                
                const byItem = {};
                recentUsage.forEach(usage => {
                    if (!byItem[usage.itemName]) {
                        byItem[usage.itemName] = { total: 0, count: 0 };
                    }
                    byItem[usage.itemName].total += usage.quantity;
                    byItem[usage.itemName].count++;
                });
                
                return Object.keys(byItem).map(itemName => ({
                    itemName,
                    totalUsed: byItem[itemName].total,
                    timesUsed: byItem[itemName].count,
                    avgPerUse: (byItem[itemName].total / byItem[itemName].count).toFixed(1)
                })).sort((a, b) => b.totalUsed - a.totalUsed);
            },

            addProjectFood() {
                const name = document.getElementById('projectFoodName').value.trim();
                const cost = parseFloat(document.getElementById('projectFoodCost').value);
                const date = document.getElementById('projectFoodDate').value;
                const project = document.getElementById('projectFoodProject').value.trim();
                
                if (!name || !cost || !date || !project) return alert('Please fill all fields');
                
                this.projectFoods.push({
                    id: Date.now(),
                    name: name,
                    cost: cost,
                    date: date,
                    project: project,
                    timestamp: new Date().toISOString()
                });
                
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Project food cost added!');
                
                document.getElementById('projectFoodName').value = '';
                document.getElementById('projectFoodCost').value = '';
                document.getElementById('projectFoodDate').value = '';
                document.getElementById('projectFoodProject').value = '';
                
                this.render();
            },

            deleteProjectFood(id) {
                if (!confirm('Delete this project food entry?')) return;
                this.projectFoods = this.projectFoods.filter(p => p.id !== id);
                this.saveProjectFoods();
                this.createBackup();
                this.showNotification('Entry deleted');
                this.render();
            },

            loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.currentView = 'admin';
                    this.render();
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

            logoutAdmin() {
                this.isAdmin = false;
                this.currentView = 'inventory';
                this.render();
            },

            downloadBackup() {
                const backup = {
                    items: this.items,
                    usageHistory: this.usageHistory,
                    projectFoods: this.projectFoods,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.items && this.validateData(backup.items)) {
                                this.items = backup.items;
                                this.usageHistory = backup.usageHistory || [];
                                this.projectFoods = backup.projectFoods || [];
                                this.save();
                                this.saveUsageHistory();
                                this.saveProjectFoods();
                                this.createBackup();
                                this.showNotification('Backup restored successfully!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            render(showAddForm = false) {
                const appEl = document.getElementById('app');
                
                if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else {
                    appEl.innerHTML = this.renderInventory(showAddForm);
                }
            },

            renderAdmin() {
                const shoppingList = this.generateShoppingList();
                const consumption = this.getConsumptionReport();
                
                const projectTotals = {};
                this.projectFoods.forEach(p => {
                    if (!projectTotals[p.project]) {
                        projectTotals[p.project] = 0;
                    }
                    projectTotals[p.project] += p.cost;
                });
                const totalProjectCosts = this.projectFoods.reduce((sum, p) => sum + p.cost, 0);
                
                const stats = {
                    total: this.items.length,
                    lowStock: this.items.filter(i => i.quantity <= (i.minstock || 5) && i.quantity > 0).length,
                    outOfStock: this.items.filter(i => i.quantity === 0).length,
                    expiringSoon: this.items.filter(i => {
                        if (!i.expirydate) return false;
                        const days = Math.ceil((new Date(i.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                        return days >= 0 && days <= 7;
                    }).length
                };

                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                                    <div class="flex gap-2">
                                        <button onclick="app.currentView='inventory'; app.render();" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Back to Inventory</button>
                                        <button onclick="app.logoutAdmin()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Logout</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
                                        <div class="text-sm text-gray-600">Total Items</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-orange-600">${stats.lowStock}</div>
                                        <div class="text-sm text-gray-600">Low Stock</div>
                                    </div>
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-red-600">${stats.outOfStock}</div>
                                        <div class="text-sm text-gray-600">Out of Stock</div>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <div class="text-2xl font-bold text-yellow-600">${stats.expiringSoon}</div>
                                        <div class="text-sm text-gray-600">Expiring Soon</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <button onclick="app.exportToCSV()" class="bg-green-600 text-white p-4 rounded-lg font-bold hover:bg-green-700">
                                        ðŸ“Š Export Full Inventory
                                    </button>
                                    <button onclick="app.downloadBackup()" class="bg-blue-600 text-white p-4 rounded-lg font-bold hover:bg-blue-700">
                                        ðŸ’¾ Download Backup
                                    </button>
                                    <button onclick="app.uploadBackup()" class="bg-orange-600 text-white p-4 rounded-lg font-bold hover:bg-orange-700">
                                        ðŸ“¤ Restore Backup
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold">Shopping List (${shoppingList.length} items)</h2>
                                    <div class="flex gap-2">
                                        <button onclick="app.downloadShoppingList()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                                            ðŸ“¥ Download CSV
                                        </button>
                                        <button onclick="app.emailShoppingList()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                                            ðŸ“§ Email List
                                        </button>
                                    </div>
                                </div>
                                <div class="max-h-96 overflow-y-auto">
                                    ${shoppingList.length === 0 ? '<p class="text-gray-500 text-center py-8">All items adequately stocked! ðŸŽ‰</p>' : `
                                        <table class="w-full">
                                            <thead class="bg-gray-100 sticky top-0">
                                                <tr>
                                                    <th class="text-left p-2">Item</th>
                                                    <th class="text-left p-2">Category</th>
                                                    <th class="text-center p-2">Current</th>
                                                    <th class="text-center p-2">Min Stock</th>
                                                    <th class="text-left p-2">Location</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${shoppingList.map(item => `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-2 font-semibold">${item.name}</td>
                                                        <td class="p-2 text-sm text-gray-600">${item.category}</td>
                                                        <td class="p-2 text-center ${item.quantity === 0 ? 'text-red-600 font-bold' : 'text-orange-600'}">${item.quantity} ${item.unit}</td>
                                                        <td class="p-2 text-center">${item.minstock || 5} ${item.unit}</td>
                                                        <td class="p-2 text-sm text-gray-600">${item.location || '-'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    `}
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4">Consumption Patterns (Last 30 Days)</h2>
                                <div class="max-h-96 overflow-y-auto">
                                    ${consumption.length === 0 ? '<p class="text-gray-500 text-center py-8">No usage data yet</p>' : `
                                        <table class="w
