<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTS Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://slelvrwtokiqlhletpsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZWx2cnd0b2tpcWxobGV0cHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODM3MTEsImV4cCI6MjA3NzM1OTcxMX0.mvO2vGyMlvmeV0tn60RL9dbzKkScBfXcFqMY-rTBmHM';
        const ADMIN_PASSWORD = 'UTS2025Admin';
        
        let supabase = null;
        let useLocalStorage = true;

        if (SUPABASE_URL && SUPABASE_KEY) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                useLocalStorage = false;
            } catch (e) {
                console.log('Using local storage mode');
            }
        }

        const app = {
            items: [],
            usageHistory: [],
            projectFoods: [],
            selectedCategory: 'All',
            currentView: 'inventory',
            isAdmin: false,
            backupCount: 10,
            editingItemId: null,
            categories: ['All', 'Pasta/Grain', 'Canned Goods', 'Disposables', 'Equipment', 'Baking', 'Condiments', 'Stocks/Gravies', 'Seasoning', 'Bread', 'Frozen Meat', 'Prepared Meals', 'Frozen Veg', 'Fresh Fruit', 'Fresh Veg', 'Dairy', 'Baked Goods', 'Giveaways', 'Toiletries', 'Showers', 'Misc'],

            async init() {
                await this.loadData();
                this.loadUsageHistory();
                this.loadProjectFoods();
                this.render();
                
                if (!useLocalStorage && supabase) {
                    supabase.channel('inventory_changes').on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'inventory' }, 
                        () => this.loadData()
                    ).subscribe();
                }
                
                setInterval(() => this.autoBackup(), 300000);
                this.createBackup();
            },

            validateData(data) {
                if (!Array.isArray(data)) return false;
                for (let item of data) {
                    if (!item.name || typeof item.name !== 'string') return false;
                    if (typeof item.quantity !== 'number') return false;
                }
                return true;
            },

            createBackup() {
                try {
                    const timestamp = new Date().toISOString();
                    const backup = {
                        items: this.items,
                        usageHistory: this.usageHistory,
                        projectFoods: this.projectFoods,
                        timestamp: timestamp,
                        version: '2.0'
                    };
                    const backups = this.getBackups();
                    backups.push(backup);
                    if (backups.length > this.backupCount) backups.shift();
                    localStorage.setItem('uts-inventory-backups', JSON.stringify(backups));
                    console.log('Backup created:', timestamp);
                } catch (e) {
                    console.error('Backup creation failed:', e);
                }
            },

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-inventory-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

            restoreFromBackup() {
                const backups = this.getBackups();
                for (let i = backups.length - 1; i >= 0; i--) {
                    const backup = backups[i];
                    if (backup.items && this.validateData(backup.items)) {
                        this.items = backup.items;
                        this.usageHistory = backup.usageHistory || [];
                        this.projectFoods = backup.projectFoods || [];
                        this.showNotification('Restored from backup: ' + new Date(backup.timestamp).toLocaleString(), 'success');
                        return true;
                    }
                }
                this.showNotification('No valid backups found', 'error');
                return false;
            },

            autoBackup() {
                if (!this.validateData(this.items)) {
                    console.error('Data validation failed - backup skipped');
                    return;
                }
                this.createBackup();
            },

            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            },

            async loadData() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-inventory');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (this.validateData(parsed)) {
                                this.items = parsed;
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        } catch (e) {
                            this.restoreFromBackup();
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').select('*').order('name');
                        if (!error && data) {
                            if (this.validateData(data)) {
                                this.items = data;
                                this.createBackup();
                            } else {
                                this.restoreFromBackup();
                            }
                        }
                    } catch (e) {
                        console.error('Error loading from database:', e);
                        this.restoreFromBackup();
                    }
                }
                this.render();
            },

            loadUsageHistory() {
                const saved = localStorage.getItem('uts-usage-history');
                if (saved) {
                    try {
                        this.usageHistory = JSON.parse(saved);
                    } catch (e) {
                        this.usageHistory = [];
                    }
                }
            },

            saveUsageHistory() {
                localStorage.setItem('uts-usage-history', JSON.stringify(this.usageHistory));
            },

            recordUsage(itemId, itemName, change) {
                if (change < 0) {
                    this.usageHistory.push({
                        itemId: itemId,
                        itemName: itemName,
                        quantity: Math.abs(change),
                        timestamp: new Date().toISOString()
                    });
                    this.saveUsageHistory();
                }
            },

            loadProjectFoods() {
                const saved = localStorage.getItem('uts-project-foods');
                if (saved) {
                    try {
                        this.projectFoods = JSON.parse(saved);
                    } catch (e) {
                        this.projectFoods = [];
                    }
                }
            },

            saveProjectFoods() {
                localStorage.setItem('uts-project-foods', JSON.stringify(this.projectFoods));
            },

            async save() {
                if (useLocalStorage) {
                    localStorage.setItem('uts-inventory', JSON.stringify(this.items));
                }
            },

            toggleAddForm() {
                const formVisible = document.getElementById('addForm')?.classList.contains('hidden') === false;
                this.editingItemId = null;
                this.render(!formVisible);
            },

            startEditItem(id) {
                this.editingItemId = id;
                this.render(true);
            },

            cancelEdit() {
                this.editingItemId = null;
                this.render(false);
            },

            async addItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                const item = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 5,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null
                };

                if (useLocalStorage) {
                    item.id = Date.now();
                    this.items.push(item);
                    this.save();
                    this.createBackup();
                } else {
                    try {
                        const { data, error } = await supabase.from('inventory').insert([item]).select();
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error saving item: ' + e.message);
                        return;
                    }
                }
                
                this.showNotification('Item added successfully!');
                this.toggleAddForm();
            },

            async updateItem() {
                const name = document.getElementById('itemName').value.trim();
                if (!name) return alert('Please enter item name');

                const updatedItem = {
                    name: name,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                    unit: document.getElementById('itemUnit').value,
                    minstock: parseInt(document.getElementById('itemMinStock').value) || 5,
                    expirydate: document.getElementById('itemExpiry').value || null,
                    location: document.getElementById('itemLocation').value.trim() || null,
                    notes: document.getElementById('itemNotes').value.trim() || null
                };

                if (useLocalStorage) {
                    const item = this.items.find(i => i.id === this.editingItemId);
                    if (item) {
                        Object.assign(item, updatedItem);
                        this.save();
                        this.createBackup();
                    }
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update(updatedItem).eq('id', this.editingItemId);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating item: ' + e.message);
                        return;
                    }
                }

                this.showNotification('Item updated successfully!');
                this.editingItemId = null;
                this.render(false);
            },

            async updateQuantity(id, change) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;

                const newQty = Math.max(0, item.quantity + change);
                this.recordUsage(id, item.name, change);

                if (useLocalStorage) {
                    item.quantity = newQty;
                    this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error updating quantity: ' + e.message);
                    }
                }
            },

            async deleteItem(id) {
                if (!confirm('Remove this item from inventory?')) return;

                if (useLocalStorage) {
                    this.items = this.items.filter(i => i.id !== id);
                    this.save();
                    this.createBackup();
                    this.render();
                } else {
                    try {
                        const { error } = await supabase.from('inventory').delete().eq('id', id);
                        if (error) throw error;
                        await this.loadData();
                    } catch (e) {
                        alert('Error deleting item: ' + e.message);
                    }
                }
                this.showNotification('Item deleted');
            },

            getItemStatus(item) {
                if (item.quantity === 0) return { color: 'bg-red-100 border-red-300', text: 'OUT OF STOCK' };
                if (item.quantity <= (item.minstock || 5)) return { color: 'bg-orange-100 border-orange-300', text: 'LOW STOCK' };
                
                if (item.expirydate) {
                    const days = Math.ceil((new Date(item.expirydate) - new Date()) / (1000 * 60 * 60 * 24));
                    if (days < 0) return { color: 'bg-red-100 border-red-300', text: 'EXPIRED' };
                    if (days <= 7) return { color: 'bg-yellow-100 border-yellow-300', text: `EXPIRES IN ${days}D` };
                }
                
                return { color: 'bg-white border-gray-200', text: '' };
            },

            exportToCSV() {
                const rows = [['Name', 'Category', 'Quantity', 'Unit', 'Min Stock', 'Location', 'Expiry Date', 'Status', 'Notes']];
                
                this.items.forEach(item => {
                    const status = this.getItemStatus(item);
                    rows.push([
                        item.name,
                        item.category,
                        item.quantity,
                        item.unit,
                        item.minstock || 5,
                        item.location || '',
                        item.expirydate || '',
                        status.text,
                        item.notes || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-inventory-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported successfully!');
            },

            generateShoppingList() {
                const needsRestock = this.items.filter(item => item.quantity <= (item.minstock || 5));
                return needsRestock.sort((a, b) => a.category.localeCompare(b.category));
            },

            emailShoppingList() {
                const list = this.generateShoppingList();
                let body = 'UTS Inventory Shopping List\n\n';
                body += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                const byCategory = {};
                list.forEach(item => {
                    if (!byCategory[item.category]) byCategory[item.category] = [];
                    byCategory[item.category].push(item);
                });
                
                Object.keys(byCategory).sort().forEach(category => {
                    body += `${category}:\n`;
                    byCategory[category].forEach(item => {
                        body += `  â€¢ ${item.name} - Current: ${item.quantity} ${item.unit}, Need: ${item.minstock || 5} ${item.unit}\n`;
                    });
                    body += '\n';
                });
                
                const mailto = `mailto:operations@underthestars.org.nz?subject=UTS Shopping List - ${new Date().toLocaleDateString()}&body=${encodeURIComponent(body)}`;
                window.location.href = mailto;
            },

            downloadShoppingList() {
                const list = this.generateShoppingList();
                const rows = [['Item', 'Category', 'Current Stock', 'Min Stock', 'Location']];
                
                list.forEach(item => {
                    rows.push([
                        item.name,
                        item.category,
                        `${item.quantity} ${item.unit}`,
                        `${item.minstock || 5} ${item.unit}`,
                        item.location || ''
                    ]);
                });
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-shopping-list-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Shopping list downloaded!');
            },

            getConsumptionReport() {
                const last30Days = new Date();
                last30Days.setDate(last30Days.getDate() - 30);
                
                const recentUsage = this.usageHistory.filter(h => new Date(h.timestamp) >= last30Days);
                
                const byItem = {};
                recentUsage.forEach(usage => {
                    if (!byItem[usage.itemName]) {
                        byItem[usage.itemName] = { total: 0, count: 0 };
                    }
                    byItem[usage.itemName].total += usage.quantity;
                    byItem[usage.itemName].count++;
                });
                
                return Object.keys(byItem).map(itemName => ({
                    itemName,
                    totalUsed: byItem[itemName].total,
                    timesUsed: byItem[itemName].count,
                    avgPerUse: (byItem[itemName].total / byItem[itemName].count).toFixed(1)
                })).sort((a, b) => b.totalUsed - a.totalUsed);
            },

            addProjectFood() {
                const name = document.getElementById('projectFoodName').value.trim();
                const cost = parseFloat(document.getElementById('projec
